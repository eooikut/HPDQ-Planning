<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>{% block title %}LSX Tracker{% endblock %}</title>
	<meta name="csrf-token" content="{{ csrf_token() }}" />
    <!-- Bootstrap & Font Awesome -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/base.css') }}"
    />
    <link
      rel="icon"
      href="{{ url_for('static', filename='image/Logo-Gang-thep-mau.png') }}"
    />

    <style>
      .update-time small {
        margin-right: 20px;
        font-size: 0.9rem;
      }
      .flash-update {
        background-color: #d4edda;
        transition: background-color 1s ease;
        border-radius: 5px;
        padding: 2px 5px;
      }
      .flash-update {
        background-color: #d4edda;
        transition: background-color 1s ease;
        border-radius: 5px;
        padding: 2px 5px;
      }
      /* ThÃªm style cho má»¥c sidebar Ä‘ang active */
      .sidebar a.active {
        background-color: #0d6efd; /* MÃ u xanh dÆ°Æ¡ng cá»§a Bootstrap */
        color: white !important;
        border-radius: 0.375rem; /* bo gÃ³c */
      }
	  /* --- CSS CHO PHáº¦N Há»– TRá»¢ SIDEBAR --- */

	/* Máº·c Ä‘á»‹nh: Hiá»ƒn thá»‹ Ä‘áº§y Ä‘á»§ */
	.support-info {
		opacity: 1;
		transition: opacity 0.3s ease;
	}

	/* KHI SIDEBAR ÄÃ“NG (.collapsed) */
	.sidebar.collapsed .support-box {
		background-color: transparent !important; /* Máº¥t mÃ u ná»n xÃ¡m */
		border: none !important;                  /* Máº¥t viá»n */
		padding: 10px 0 !important;               /* Giáº£m padding */
	}

	.sidebar.collapsed .support-title,   /* áº¨n tiÃªu Ä‘á» "LIÃŠN Há»†..." */
	.sidebar.collapsed .support-detail,  /* áº¨n tÃªn, phÃ²ng ban */
	.sidebar.collapsed .support-email-btn { /* áº¨n nÃºt email */
		display: none !important;
	}

	.sidebar.collapsed .support-avatar {
		margin: 0 auto !important; /* CÄƒn giá»¯a avatar khi Ä‘Ã³ng */
		width: 40px !important;    /* KÃ­ch thÆ°á»›c gá»n gÃ ng */
		height: 40px !important;
		font-size: 0.8rem !important;
		background-color: #0d6efd !important; /* MÃ u xanh Ä‘áº­m hÆ¡n cho ná»•i */
		box-shadow: 0 2px 5px rgba(0,0,0,0.2);
	}
    </style>
  </head>

  <body>
    <!-- ğŸ” TOPBAR -->
    <nav
      class="navbar navbar-light bg-white shadow-sm fixed-top d-flex justify-content-between align-items-center px-3"
    >
      <div class="d-flex align-items-center">
        <!-- Logo -->
        <a class="navbar-brand d-flex align-items-center mb-0 h1" href="#">
          <img
            src="{{ url_for('static', filename='image/Logo-Gang-thep-mau.png') }}"
            alt="Logo"
            height="40"
          />
        </a>

        <!-- Toggle -->
        <button id="sidebarToggle" class="btn btn-outline-primary me-2">
          <i class="fas fa-bars"></i>
        </button>
      </div>

      <!-- Thá»i gian cáº­p nháº­t -->
      <div class="update-time d-flex align-items-center text-muted">
        <small id="so_time">
          ğŸ“¦ SO: {% if so_created_at %} {{ so_created_at.strftime("%Y-%m-%d
          %H:%M:%S") }} {% else %} Äang cáº­p nháº­t... {% endif %}
        </small>
        <small id="sl_time">
          ğŸ­ Kho, sáº£n lÆ°á»£ng: {% if sl_kho_created_at %} {{
          sl_kho_created_at.strftime("%Y-%m-%d %H:%M:%S") }} {% else %} Äang cáº­p
          nháº­t... {% endif %}
        </small>
        <small id="lichtau_time">
          ğŸš¢ Lá»‹ch tÃ u: Äang cáº­p nháº­t...
        </small>
		<small id="donhangchitiet_time">
          ğŸ§¾ ÄÆ N HÃ€NG CHI TIáº¾T: Äang cáº­p nháº­t...
        </small>
      </div>

      <!-- User -->
      <div class="d-flex align-items-center">
        {% if session.get('user_id') %}
        <span class="me-3">ğŸ‘‹ Xin chÃ o, {{ session.get('username') }}</span>
        <a
          class="btn btn-outline-danger btn-sm"
          href="{{ url_for('auth.logout') }}"
        >
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
        {% else %}
        <a
          class="btn btn-outline-primary btn-sm"
          href="{{ url_for('auth.login') }}"
        >
          <i class="fas fa-sign-in-alt"></i> Login
        </a>
        {% endif %}
      </div>
    </nav>

    <!-- ğŸ“ SIDEBAR -->
    <div class="sidebar">
      <h6>BÃO CÃO</h6>
      {% if 'view_ship_schedule' in session.get('permissions', []) or session.get('role') == 'admin' %}
      <a href="{{ url_for('dashboard_bp.dashboard') }}"
        ><i class="fas fa-tachometer-alt"></i><span>Dashboard TÃ u</span></a>
      {% endif %}
	  {% if 'view_cpk_kho' in session.get('permissions', []) or session.get('role') == 'admin' %}
      <a href="{{ url_for('dashboard_so_bp.dashboard_inventory') }}"><i class="fas fa-sitemap"></i><span>Dashboard Kho</span></a>
      {% endif %}
      {% if 'view_cpk_kho' in session.get('permissions', []) or session.get('role') == 'admin' %}
      <a href="{{ url_for('dashboard_so_bp.dashboard_capacity') }}"><i class="fas fa-sitemap"></i><span>Dashboard CPK</span></a>
      {% endif %}
	  {% if 'view_ship_schedule' in session.get('permissions', []) or session.get('role') == 'admin' %}
	  <a href="{{ url_for('tau_bp.lichtau') }}"
        ><i class="fas fa-ship"></i><span>Check Lá»‹ch tÃ u</span></a>
	  {% endif %}
      {% if 'view_order' in session.get('permissions', []) or session.get('role') == 'admin' %}
      <a href="{{ url_for('report.order') }}"
        ><i class="fas fa-chart-line"></i><span>Check Order</span></a
      >
      {% endif %}
      {% if 'view_customer' in session.get('permissions', []) or session.get('role') == 'admin' %}
      <a href="{{ url_for('so.so_all') }}"
        ><i class="fas fa-users"></i><span>Check KhÃ¡ch hÃ ng</span></a
      >
      {% endif %}
      {% if 'view_coil_id' in session.get('permissions', []) or session.get('role') == 'admin' %}
      <a href="{{ url_for('idcuonbo_bp.idcuonbo') }}"
        ><i class="fas fa-list"></i><span>Check ID Cuá»™n</span></a
      >
      {% endif %}
      {% if 'view_lsx_report' in session.get('permissions', []) or session.get('role') == 'admin' %}
      <a href="{{ url_for('reportlsx.lsx_all') }}"
        ><i class="fas fa-calendar-day"></i><span>Check LSX</span></a
      >
      {% endif %}

      {% if 'manage_lsx' in session.get('permissions', []) or session.get('role') == 'admin' %}
      <h6>KIá»‚M SOÃT</h6>
      <a href="{{ url_for('lsx.danhsach_lsx') }}" title="Danh sÃ¡ch LSX">
        <i class="fas fa-list"></i><span>Danh sÃ¡ch LSX</span>
      </a>
	  <a href="{{ url_for('lsx.lap_lsx') }}" title="Láº­p Form LSX">
Â  Â  Â  Â  <i class="fas fa-edit"></i><span>Láº­p Form LSX</span>
Â  Â  Â  </a>
      {% endif %}
      {% if 'manage_users' in session.get('permissions', []) or session.get('role') == 'admin' %}
      <a href="{{ url_for('kho2d_bp.kho2d') }}" title="Kho 2D">
        <i class="fas fa-users-cog"></i><span>Kho 2D</span>
      </a>
      {% endif %}
      {% if 'manage_users' in session.get('permissions', []) or session.get('role') == 'admin' %}
      <a href="{{ url_for('user.list_users') }}" title="Quáº£n lÃ½ ngÆ°á»i dÃ¹ng">
        <i class="fas fa-users-cog"></i><span>Quáº£n lÃ½ ngÆ°á»i dÃ¹ng</span>
      </a>
      {% endif %}
	  {% if 'upload_files' in session.get('permissions', []) or session.get('role') == 'admin' %}
      <h6>THAO TÃC</h6>
      <a class="text-success" href="{{ url_for('upload.upload_files') }}">
        <i class="fas fa-upload"></i><span>Upload LSX hoáº·c Lá»‹ch tÃ u</span>
      </a>
      {% endif %}
	  <h6>CÃ”NG Cá»¤</h6>
      <a href="{{ url_for('tools.production_calc') }}"> <i class="fas fa-calculator"></i><span>TÃ­nh toÃ¡n Sáº£n xuáº¥t</span>
      </a>
	  <!-- ğŸ“„ SUPPORT -->
	  <div class="mx-2 mb-1" style="margin-top: 80px;">
		  <div class="support-box p-3 bg-light rounded-3 border transition-all">
			
			<div class="support-title text-uppercase text-secondary fw-bold mb-2" style="font-size: 0.7rem; letter-spacing: 1px;">
			  <i class="fas fa-headset me-1"></i> LiÃªn há»‡ há»— trá»£
			</div>
			
			<div class="d-flex align-items-center mb-2 justify-content-center justify-content-md-start">
			  <div class="support-avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center flex-shrink-0 me-md-2" 
				   style="width: 35px; height: 35px; font-size: 0.9rem; transition: all 0.3s;">
				NC
			  </div>
			  
			  <div class="support-detail" style="line-height: 1.2;">
				<div class="fw-bold text-dark" style="font-size: 0.9rem; white-space: nowrap;">Nguyá»…n VÄƒn CÃ´ng</div>
				<small class="text-muted" style="font-size: 0.75rem; white-space: nowrap;">P. Káº¿ hoáº¡ch</small>
			  </div>
			</div>

			<button onclick="copyEmail(this)" 
					data-email="congnv@hoaphat.com.vn" 
					class="support-email-btn btn btn-outline-primary btn-sm w-100 d-flex align-items-center justify-content-center" 
					style="font-size: 0.8rem; transition: all 0.2s; user-select: text !important; -webkit-user-select: text !important; cursor: text;">
			  <i class="fas fa-envelope me-2"></i> <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">congnv@HP...</span>
			</button>
		  </div>
		</div>
    </div>

    <!-- ğŸ“„ MAIN CONTENT -->
    <div class="main-content">{% block content %}{% endblock %}</div>

    <!-- ğŸ”” TOAST -->
    <div id="flash-toast-container">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="toast align-items-center text-bg-{{ 'danger' if category=='danger' else 'success' }} border-0 mb-2"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div class="toast-body">{{ message }}</div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
      </div>
      {% endfor %} {% endif %} {% endwith %}
    </div>
	<script>
	  function copyEmail(btn) {
		// ... (Giá»¯ nguyÃªn code script copy email cÅ© cá»§a báº¡n) ...
		const email = btn.getAttribute('data-email');
		const icon = btn.querySelector('i');
		const textSpan = btn.querySelector('span');
		const originalText = textSpan.textContent; 

		navigator.clipboard.writeText(email).then(() => {
		  btn.classList.remove('btn-outline-primary');
		  btn.classList.add('btn-success');
		  icon.className = 'fas fa-check me-2';
		  textSpan.textContent = 'ÄÃ£ copy!';

		  setTimeout(() => {
			btn.classList.remove('btn-success');
			btn.classList.add('btn-outline-primary');
			icon.className = 'fas fa-envelope me-2';
			textSpan.textContent = originalText;
		  }, 2000);
		}).catch(err => {
			alert('KhÃ´ng thá»ƒ copy: ' + email);
		});
	  }
	</script>
    <!-- ğŸ§  SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const sidebar = document.querySelector(".sidebar");
        const mainContent = document.querySelector(".main-content");
        const toggleBtn = document.getElementById("sidebarToggle");

        toggleBtn.addEventListener("click", function () {
          sidebar.classList.toggle("collapsed");
          mainContent.classList.toggle("collapsed");
        });

        // Hiá»ƒn thá»‹ toast tá»± Ä‘á»™ng
        document.querySelectorAll(".toast").forEach((toastEl) => {
          const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
          toast.show();
        });

        // ğŸ” Cáº­p nháº­t thá»i gian file
        function updateTimes() {
          fetch("/api/file-times")
            .then((response) => response.json())
            .then((data) => {
              updateTimeDisplay(
                "so_time",
                "ğŸ“¦ SO",
                data.so_created_at,
                data.so_status
              );
              updateTimeDisplay(
                "sl_time",
                "ğŸ­ Kho",
                data.sl_kho_created_at,
                data.sl_status
              );
              updateShipDisplay("lichtau_time", "ğŸš¢ Lá»‹ch tÃ u", data.lichtau_name, data.lichtau_time);
			  updateShipDisplay(
                "donhangchitiet_time", 
                "ğŸ§¾ÄÆ N HÃ€NG CHI TIáº¾T", // Báº¡n cÃ³ thá»ƒ Ä‘á»•i tÃªn label nÃ y
                data.donhangchitiet_name, 
                data.donhangchitiet_time
              );
            })
            .catch((err) => {
              document.getElementById("so_time").textContent =
                "ğŸ“¦ SO: Máº¥t káº¿t ná»‘i server";
              document.getElementById("sl_time").textContent =
                "ğŸ­ Kho: Máº¥t káº¿t ná»‘i server";
              console.error("Lá»—i cáº­p nháº­t thá»i gian:", err);
            });
        }

        // ğŸ”¦ Cáº­p nháº­t ná»™i dung & hiá»‡u á»©ng
        function updateTimeDisplay(id, label, time, status) {
          const el = document.getElementById(id);
          if (status === "updating") {
            el.textContent = `${label}: Äang cáº­p nháº­t...`;
            el.style.color = "orange";
            el.classList.remove("flash-update");
          } else {
            const newText = `${label}: ${time}`;
            if (el.textContent !== newText) {
              el.textContent = newText;
              el.style.color = "green";
              flash(el);
            }
          }
        }
        function updateShipDisplay(id, label, name, time) {
        const el = document.getElementById(id);
        if (!time) {
          el.textContent = `${label}: Äang cáº­p nháº­t...`;
          el.style.color = "orange";
        } else {
          const newText = `${label}: ${name} (${time})`;
          if (el.textContent !== newText) {
            el.textContent = newText;
            el.style.color = "green";
            flash(el);
          }
        }
      }
              // ğŸ’¥ Hiá»‡u á»©ng nháº¥p nhÃ¡y khi cáº­p nháº­t má»›i
        function flash(el) {
          el.classList.add("flash-update");
          setTimeout(() => el.classList.remove("flash-update"), 1500);
        }

        // Cáº­p nháº­t má»—i 5 giÃ¢y
        updateTimes();
        setInterval(updateTimes, 30000);
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Láº¥y Ä‘Æ°á»ng dáº«n URL hiá»‡n táº¡i
        const currentPath = window.location.pathname;

        // Láº¥y táº¥t cáº£ cÃ¡c liÃªn káº¿t trong sidebar
        const sidebarLinks = document.querySelectorAll(".sidebar a");
        
        let mostSpecificLink = null;
        let maxMatchLength = 0;

        sidebarLinks.forEach((link) => {
          // Láº¥y Ä‘Æ°á»ng dáº«n tá»« thuá»™c tÃ­nh href cá»§a link
          const linkPath = new URL(link.href).pathname;

          // 1. Bá» qua trang chá»§ '/' Ä‘á»ƒ trÃ¡nh active nháº§m táº¥t cáº£
          // 2. Kiá»ƒm tra xem Ä‘Æ°á»ng dáº«n hiá»‡n táº¡i cÃ³ chá»©a Ä‘Æ°á»ng dáº«n cá»§a link khÃ´ng
          if (linkPath !== "/" && currentPath.startsWith(linkPath)) {
            
            // LOGIC Má»šI: Chá»‰ chá»n link cÃ³ Ä‘á»™ dÃ i khá»›p lá»›n nháº¥t
            // VÃ­ dá»¥: '/dashboard/kho' (dÃ i hÆ¡n) sáº½ tháº¯ng '/dashboard' (ngáº¯n hÆ¡n)
            if (linkPath.length > maxMatchLength) {
                mostSpecificLink = link;
                maxMatchLength = linkPath.length;
            }
          }
          // Xá»­ lÃ½ riÃªng cho trang chá»§ (Dashboard chÃ­nh) náº¿u cáº§n thiáº¿t káº¿ trÃ¹ng khá»›p hoÃ n toÃ n
          else if (linkPath === "/" && currentPath === "/") {
             mostSpecificLink = link;
          }
        });

        // Chá»‰ thÃªm class active cho link cá»¥ thá»ƒ nháº¥t tÃ¬m Ä‘Æ°á»£c
        if (mostSpecificLink) {
            mostSpecificLink.classList.add("active");
        }
      });
    </script>
  </body>
</html>
