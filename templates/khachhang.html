{% extends "base.html" %} {% block title %}Tiáº¿n Ä‘á»™ SO theo khÃ¡ch hÃ ng{% endblock
%} {% block content %}
<div class="page-wrapper">
<h3 style="margin-bottom: 20px">Check KHÃCH HÃ€NG</h3>

<form class="d-flex mb-3" style="max-width: 600px">
  <input
    type="text"
    class="form-control me-2"
    id="keyword"
    placeholder="TÃ¬m SO Mapping hoáº·c Material..."
  />
</form>

<div class="d-flex mb-3 gap-2 align-items-end" style="max-width: 1500px">
  <select id="filter-customer" class="form-select" style="width:auto; max-width:400px" >
    <option value="">-- Táº¥t cáº£ Customer --</option>
    {% for c in customer_list %}
    <option value="{{ c }}">{{ c }}</option>
    {% endfor %}
  </select>
  <select id="filter-factory" class="form-select" style="width:auto; max-width:400px">
    <option value="">-- Táº¥t cáº£ NhÃ  mÃ¡y--</option>
    {% for f in factory_list %}
    <option value="{{ f }}">{{ f }}</option>
    {% endfor %}
  </select>
  <select id="filter-process" class="form-select" style="width:auto; max-width:400px">
    <option value="">-- Táº¥t cáº£ Process --</option>
    {% for color, name in process_list %}
    <option value="{{ color }}">{{ name }}</option>
    {% endfor %}
  </select>
  <button type="button" id="btn-reset" class="btn btn-secondary">Reset</button>
  <button type="button" id="btn-export" class="btn btn-success" style="padding: 6px 12px;width: 120px">Export Excel</button>
</div>

<div style="overflow-y: auto; overflow-x: auto;flex-grow: 1;">
  <table class="table-custom" id="khachhang-table">
    <thead>
      <tr>
        <th>MÃ£ KH</th>
        <th>TÃªn KhÃ¡ch HÃ ng</th>
        <th>Sales Order</th>
        <th>NhÃ  mÃ¡y</th>
        <th>NgÃ y yÃªu cáº§u</th>
        <th>Material</th>
        <th>Mapping kho</th>
        <th>Shipped</th>
        <th>Quantity</th>
        <th>Tiáº¿n Ä‘á»™</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
</div>
<style>
	.page-wrapper {
  display: flex;
  flex-direction: column;
  /* Giáº£ sá»­ <body> hoáº·c container cha cá»§a block nÃ y cao 100% mÃ n hÃ¬nh.
     Náº¿u khÃ´ng, báº¡n cÃ³ thá»ƒ cáº§n dÃ¹ng: height: 90vh; (hoáº·c 100vh)
     tuá»³ thuá»™c vÃ o layout `base.html` cá»§a báº¡n */
  height: calc(100vh - 100px); /* VÃ­ dá»¥: 100% chiá»u cao trá»« Ä‘i 100px cá»§a header/footer */
  /* Hoáº·c Ä‘Æ¡n giáº£n lÃ : */
  /* height: 100%;  */
}
  /* ====== Table base ====== */
  .table-custom {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;

    /* TÃ™Y CHá»ˆNH */
    --thead-height: 48px; /* chá»‰nh náº¿u header cao hÆ¡n */
    --col1-width: 120px; /* chá»‰nh theo layout thá»±c táº¿ */
  }

  /* chung cho th/td */
  .table-custom th,
  .table-custom td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: center;
  }

  /* ====== Sticky THEAD ====== */
  .table-custom thead th {
    position: sticky;
    top: 0;
    background: #212529;
    color: #fff;
    z-index: 700; /* very high so header always above everything */
  }

  /* ====== Left columns sizing ====== */
  /* Ä‘áº£m báº£o td cá»™t 1 cá»‘ Ä‘á»‹nh width Ä‘á»ƒ tÃ­nh left cho cá»™t 2 Ä‘Ãºng */
  .table-custom th:first-child,
  .table-custom td.customer-cell {
    width: var(--col1-width);
    min-width: var(--col1-width);
    max-width: var(--col1-width);
    box-sizing: border-box;
  }

  /* ====== Header sticky ngang cho 2 cá»™t Ä‘áº§u ====== */
  .table-custom th:first-child {
    position: sticky;
    left: 0;
    z-index: 650;
    background: #212529;
    color: #fff;
  }
  .table-custom th:nth-child(2) {
    position: sticky;
    left: calc(var(--col1-width));
    z-index: 650;
    background: #212529;
    color: #fff;
  }

  /* ====== IMPORTANT: td khÃ´ng ustawion top (static) Ä‘á»ƒ trÃ¡nh Ã´m rowspan ====== */
  .table-custom td.customer-cell,
  .table-custom td.customer-name {
    position: static; /* keep td static to avoid row-span sticky issues */
    vertical-align: top;
    text-align: left;
    padding-left: 8px;
    background: inherit; /* inherit group background */
  }

  /* ====== sticky inner wrapper: will stick under the thead ====== */
  .sticky-content {
    position: sticky;
    top: var(--thead-height); /* dÃ­nh ngay dÆ°á»›i header */
    display: block;
    width: 100%;
    box-sizing: border-box;
    z-index: 600; /* < thead (700) so header stays above */
    padding: 0;
    margin: 0;
    background: inherit !important; /* Äƒn mÃ u nhÃ³m */
  }

  /* offsets for the inner sticky wrapper so it matches left positions */
  .sticky-col1 {
    left: 0;
  }
  .sticky-col2 {
    left: calc(var(--col1-width));
  }

  /* box shadow line between sticky columns and rest of table */
  .table-custom th:first-child,
  .table-custom th:nth-child(2),
  .table-custom td.customer-cell,
  .table-custom td.customer-name {
    box-shadow: 1px 0 0 #ddd;
  }

  /* ====== Progress bar (kept) ====== */
  .progress {
    height: 22px;
    border-radius: 12px;
    overflow: hidden;
    background: #e9ecef;
  }
  .progress-bar {
    line-height: 22px;
    color: #fff;
    font-weight: bold;
    border-radius: 12px;
    text-align: center;
  }

  /* Text helper */
  .text-right {
    text-align: right;
  }
  .customer-name {
    font-weight: bold;
    font-size: 16px;
  }

  /* ====== group background (renderRows sáº½ gÃ¡n class group-odd/group-even cho tr) ====== */
  .group-odd td {
    background-color: #f6f6f6;
  }
  .group-even td {
    background-color: #ffffff;
  }

  /* ensure sticky inner wrapper shows group bg */
  .table-custom td.customer-cell .sticky-content,
  .table-custom td.customer-name .sticky-content {
    background-color: inherit !important;
  }

  /* thick bottom border for separation (applied to the td elements for the group) */
  .table-custom td.customer-border {
    border-bottom: 2px solid #000 !important;
  }
</style>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
  const tbody = document.querySelector("#khachhang-table tbody");
  const kw = document.getElementById("keyword");
  const filterCustomer = document.getElementById("filter-customer");
  const btnReset = document.getElementById("btn-reset");
  const filterProcess = document.getElementById("filter-process");
  const filterFactory = document.getElementById("filter-factory");

  // Div phÃ¢n trang
  let paginationDiv = document.createElement("div");
  paginationDiv.id = "pagination";
  paginationDiv.className =
    "d-flex justify-content-center align-items-center gap-2 mt-3";
  document.querySelector("#khachhang-table").after(paginationDiv);

  let currentController = null;
  let allGroups = [];
  let currentPage = 1;
  const pageSize = 10; // sá»‘ customer má»—i trang

  // ===============================
  // ğŸ”¹ Láº¥y bá»™ lá»c hiá»‡n táº¡i
  // ===============================
  function getFilters() {
    const params = new URLSearchParams(window.location.search);
    return {
      keyword: kw.value.trim(),
      customer: filterCustomer.value,
      process_color: filterProcess.value,
      factory: filterFactory.value,
    };
  }
function updateURL() {
  const filters = getFilters();
  const params = new URLSearchParams(filters);
  window.history.replaceState({}, "", `${window.location.pathname}?${params.toString()}`);
}
  // ===============================
  // ğŸ”¹ Gá»i API láº¥y dá»¯ liá»‡u
  // ===============================
  async function fetchRows() {
    
    if (currentController) currentController.abort();
    currentController = new AbortController();
    updateURL();
    const params = new URLSearchParams(getFilters());

    tbody.innerHTML = `
      <tr><td colspan="10" class="text-center py-3 text-muted">
        <div class="spinner-border spinner-border-sm me-2"></div>Äang táº£i dá»¯ liá»‡u...
      </td></tr>
    `;

    try {
      const res = await fetch(`/tiendo_search?${params.toString()}`, {
        signal: currentController.signal,
      });
      const data = await res.json();
      prepareGroups(data.rows);
    } catch (err) {
      if (err.name !== "AbortError") {
        tbody.innerHTML = `<tr><td colspan="10" class="text-danger text-center py-2">Lá»—i táº£i dá»¯ liá»‡u</td></tr>`;
        console.error(err);
      }
    }
  }

  // ===============================
  // ğŸ”¹ Gom nhÃ³m theo customer
  // ===============================
  function prepareGroups(rows) {
    let lastCustomer = null;
    let currentGroup = [];
    let groups = [];

    rows.forEach((r) => {
      if (r.customer_num && r.customer_num !== lastCustomer) {
        if (currentGroup.length > 0) groups.push(currentGroup);
        currentGroup = [];
        lastCustomer = r.customer_num;
      }
      currentGroup.push(r);
    });
    if (currentGroup.length > 0) groups.push(currentGroup);

    allGroups = groups;
    currentPage = 1;
    renderPage(currentPage);
  }

  // ===============================
  // ğŸ”¹ Render 1 trang dá»¯ liá»‡u
  // ===============================
  function renderPage(page) {
    tbody.innerHTML = "";
    const totalPages = Math.ceil(allGroups.length / pageSize);
    const start = (page - 1) * pageSize;
    const end = start + pageSize;
    const pageGroups = allGroups.slice(start, end);

    let groupIndex = start;
    const custNumTdByCustomer = {};
    const custNameTdByCustomer = {};

    pageGroups.forEach((group) => {
      groupIndex++;
      group.forEach((r) => {
        const tr = document.createElement("tr");
        tr.classList.add(groupIndex % 2 === 1 ? "group-odd" : "group-even");

        // Customer cá»™t Ä‘áº§u tiÃªn (chá»‰ á»Ÿ dÃ²ng Ä‘áº§u nhÃ³m)
        if (r.customer_num) {
          const tdCNum = document.createElement("td");
          tdCNum.rowSpan = r.cust_rowspan || 1;
          tdCNum.classList.add("customer-cell");
          const wrapNum = document.createElement("div");
          wrapNum.className = "sticky-content sticky-col1";
          wrapNum.textContent = r.customer_num;
          tdCNum.appendChild(wrapNum);
          tr.appendChild(tdCNum);

          const tdCName = document.createElement("td");
          tdCName.rowSpan = r.cust_rowspan || 1;
          tdCName.classList.add("customer-name");
          const wrapName = document.createElement("div");
          wrapName.className = "sticky-content sticky-col2";
          wrapName.textContent = r.customer_name;
          tdCName.appendChild(wrapName);
          tr.appendChild(tdCName);

          custNumTdByCustomer[r.customer_num] = tdCNum;
          custNameTdByCustomer[r.customer_num] = tdCName;
        }

        // SO, Factory, ReqDate
        if (r.so_mapping) {
          const tdSo = document.createElement("td");
          tdSo.rowSpan = r.so_rowspan || 1;
          tdSo.textContent = r.so_mapping;
          tr.appendChild(tdSo);

          const tdFactory = document.createElement("td");
          tdFactory.rowSpan = r.so_rowspan || 1;
          tdFactory.textContent = r.factory || "";
          tr.appendChild(tdFactory);

          const tdReq = document.createElement("td");
          tdReq.rowSpan = r.so_rowspan || 1;
          tdReq.textContent = r.req_date || "";
          tr.appendChild(tdReq);
        }

        // Material
        const tdMat = document.createElement("td");
        tdMat.textContent = r.material || "";
        tr.appendChild(tdMat);

        // Mapping kho
        const tdMapping = document.createElement("td");
        tdMapping.textContent = r.mapping_kho ?? "";
        tdMapping.className = "text-right";
        tr.appendChild(tdMapping);

        // Shipped + Qty
        ["shipped_qty", "qty"].forEach((k) => {
          const td = document.createElement("td");
          td.textContent = r[k] || "";
          td.className = "text-right";
          tr.appendChild(td);
        });

        // Tiáº¿n Ä‘á»™
        const tdProcess = document.createElement("td");
        const progress = document.createElement("div");
        progress.className = "progress position-relative";
        const bar = document.createElement("div");
        bar.className = "progress-bar " + (r.process_color || "");
        bar.style.width = (r.process_value || 0) + "%";
        const spanText = document.createElement("span");
        spanText.textContent = (r.process_value || 0).toFixed(1) + "%";
        spanText.style.position = "absolute";
        spanText.style.width = "100%";
        spanText.style.textAlign = "center";
        spanText.style.fontWeight = "bold";
        progress.appendChild(bar);
        progress.appendChild(spanText);
        tdProcess.appendChild(progress);
        tr.appendChild(tdProcess);

        // Border cuá»‘i nhÃ³m
        if (r.is_last_row_of_customer) {
          const tdNum = custNumTdByCustomer[r.customer_num];
          const tdName = custNameTdByCustomer[r.customer_num];
          if (tdNum) tdNum.classList.add("customer-border");
          if (tdName) tdName.classList.add("customer-border");
        }

        tbody.appendChild(tr);
      });
    });

    renderPagination(page, totalPages);
setTimeout(() => {
  const table = document.querySelector("#khachhang-table");
  if (table) {
    const container = table.closest(".table-responsive") || table.parentElement;
    if (container) container.scrollTop = 0;
  }
}, 100);
  }

  // ===============================
  // ğŸ”¹ Render pagination control
  // ===============================
  function renderPagination(page, totalPages) {
    paginationDiv.innerHTML = "";

    if (totalPages <= 1) {
      paginationDiv.style.display = "none";
      return;
    }
    paginationDiv.style.display = "flex";

    const prev = document.createElement("button");
    prev.className = "btn btn-sm btn-outline-secondary";
    prev.textContent = "Â«";
    prev.disabled = page === 1;
    prev.onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        renderPage(currentPage);
      }
    };
    paginationDiv.appendChild(prev);

    const span = document.createElement("span");
    span.textContent = `Trang ${page}/${totalPages}`;
    paginationDiv.appendChild(span);

    const next = document.createElement("button");
    next.className = "btn btn-sm btn-outline-secondary";
    next.textContent = "Â»";
    next.disabled = page === totalPages;
    next.onclick = () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderPage(currentPage);
      }
    };
    paginationDiv.appendChild(next);
  }

  // ===============================
  // ğŸ”¹ Debounce & Events
  // ===============================
  function debounce(fn, delay) {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn.apply(this, args), delay);
    };
  }
  const debouncedFetch = debounce(fetchRows, 500);

  filterProcess.addEventListener("change", fetchRows);
  filterCustomer.addEventListener("change", fetchRows);
  filterFactory.addEventListener("change", fetchRows);
  kw.addEventListener("input", debouncedFetch);

  btnReset.addEventListener("click", () => {
    kw.value = "";
    filterCustomer.value = "";
    filterProcess.value = "";
    filterFactory.value = "";
    fetchRows();
  });
  function restoreFiltersFromURL() {
  const params = new URLSearchParams(window.location.search);
  if (params.has("keyword")) kw.value = params.get("keyword");
  if (params.has("customer")) filterCustomer.value = params.get("customer");
  if (params.has("process_color")) filterProcess.value = params.get("process_color");
  if (params.has("factory")) filterFactory.value = params.get("factory");
  }
  // ===============================
  // ğŸ”¹ Khá»Ÿi cháº¡y ban Ä‘áº§u
  // ===============================
  restoreFiltersFromURL()
  fetchRows();
// --- EXPORT EXCEL ---
$("#btn-export").on("click", function() {
    // Sá»¬A Láº I CHO ÄÃšNG CÃC BIáº¾N ÄÃƒ Äá»ŠNH NGHÄ¨A
Â  Â  const params = new URLSearchParams({
Â  Â  Â  Â  keyword: kw.value,                 // DÃ¹ng kw.value
Â  Â  Â  Â  customer: filterCustomer.value,    // DÃ¹ng .value
Â  Â  Â  Â  process_color: filterProcess.value,// DÃ¹ng .value
Â  Â  Â  Â  factory: filterFactory.value       // DÃ¹ng .value
Â  Â  });

Â  Â  // Táº¡o URL vÃ  Ä‘iá»u hÆ°á»›ng Ä‘á»ƒ trÃ¬nh duyá»‡t tá»± táº£i file vá»
Â  Â  const exportUrl = `/export_khachhang?${params.toString()}`;
Â  Â  window.location.href = exportUrl;
});
</script>
{% endblock %}
