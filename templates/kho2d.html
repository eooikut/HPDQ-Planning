{% extends "base.html" %} {% block title %}Qu·∫£n L√Ω Layout Kho ƒêa ƒêi·ªÉm{% endblock
%} {% block content %}
<style>
  /* --- 1. LAYOUT CH√çNH --- */
  body {
    overflow: hidden;
  }

  .kho-wrapper {
    padding: 15px;
    background: #eef2f5;
    margin-top: 65px;
    height: calc(100vh - 65px);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }

  .top-dashboard {
    flex-shrink: 0;
    display: flex;
    gap: 15px;
    margin-bottom: 10px;
    align-items: stretch;
  }
  .stats-box {
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 10px 15px;
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 13px;
    flex: 1;
  }
  .stat-mini {
    text-align: center;
    cursor: pointer;
    padding: 2px 10px;
    border-radius: 4px;
    transition: background 0.2s;
  }
  .stat-mini:hover {
    background: #f0f0f0;
  }
  .stat-mini b {
    display: block;
    font-size: 18px;
  }
  .stat-mini span {
    font-size: 10px;
    text-transform: uppercase;
    color: #777;
  }

  .tab-header {
    display: flex;
    gap: 5px;
    margin-bottom: 0;
    border-bottom: 1px solid #ccc;
    padding-left: 5px;
  }
  .tab-btn {
    padding: 8px 20px;
    border: 1px solid transparent;
    border-bottom: none;
    background: #e9ecef;
    cursor: pointer;
    font-weight: bold;
    border-radius: 6px 6px 0 0;
    color: #555;
    transition: all 0.2s;
  }
  .tab-btn.active {
    background: #fff;
    border-color: #ccc;
    border-bottom: 2px solid #fff;
    margin-bottom: -1px;
    z-index: 2;
  }
  #btn-hspm.active {
    color: #007bff;
    border-top: 3px solid #007bff;
  }
  #btn-hrc1.active {
    color: #6f42c1;
    border-top: 3px solid #6f42c1;
  }
  #btn-hrc2.active {
    color: #e83e8c;
    border-top: 3px solid #e83e8c;
  }
  .tab-content {
    display: none;
    height: 100%;
    flex-direction: column;
  }
  .tab-content.active {
    display: flex;
  }

  .warehouse-scroll-area {
    flex-grow: 1;
    overflow-y: auto;
    background: #fff;
    border-radius: 0 0 8px 8px;
    padding: 15px;
    border: 1px solid #ccc;
    border-top: none;
    position: relative;
    scroll-padding-top: 50px;
  }
  .warehouse-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    width: 100%;
    padding-bottom: 150px;
  }

  .zone-card {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    border-top: 3px solid #0056b3;
    padding: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    overflow-x: auto;
    max-width: 100%;
    content-visibility: auto;
    contain-intrinsic-size: 500px 300px;
  }
  .zone-title {
    font-weight: bold;
    text-align: center;
    background: #f1f3f5;
    padding: 4px;
    margin-bottom: 5px;
    font-size: 14px;
    color: #333;
    position: sticky;
    left: 0;
  }
  .line-row {
    display: flex;
    align-items: flex-end;
    border-bottom: 1px dashed #eee;
    padding: 4px 0;
    width: max-content;
    min-width: 100%;
  }
  .line-name {
    width: 35px;
    font-weight: bold;
    color: #d63384;
    font-size: 11px;
    flex-shrink: 0;
    position: sticky;
    left: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 5;
    text-align: center;
    margin-right: 5px;
  }
  .pyramid-container {
    display: flex;
    flex-direction: column;
    width: max-content;
  }
  .tier {
    display: flex;
    height: 22px;
    margin-bottom: -2px;
    width: max-content;
  }
  .tier.t3 {
    margin-left: 22px;
  }
  .tier.t2 {
    margin-left: 11px;
  }
  .tier.t1 {
    margin-left: 0px;
  }

  .coil {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 1px solid #ccc;
    background: #f0f0f0;
    margin-right: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 7px;
    color: #555;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s, opacity 0.3s filter 0.3s;
  }
  .coil.ok {
    background-color: #28a745;
    color: #fff;
    border-color: #1e7e34;
  }
  .coil.empty-so {
    background-color: #adb5bd;
    color: #fff;
    border-color: #6c757d;
  }
  .coil.auto {
    background-color: #fd7e14;
    color: #fff;
    border-color: #e65100;
  }
  .coil.error {
    background-color: #dc3545;
    color: #fff;
    border: 2px solid red;
  }
  .coil:hover {
    border-color: #000;
    transform: scale(1.5);
    z-index: 100;
    background-color: #fff;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    color: #000;
  }

  .warehouse-scroll-area.is-filtering .coil {
    opacity: 0.05;
    filter: grayscale(100%);
    transform: scale(0.8);
  }
  .warehouse-scroll-area.is-filtering .coil.match {
    opacity: 1 !important;
    filter: none !important;
    transform: scale(1.6) !important;
    z-index: 999;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
    border: 2px solid #fff !important;
  }

  /* SEARCH PANEL (DRAGGABLE) */
  .search-result-panel {
    display: none;
    position: fixed;
    top: 100px;
    right: 50px;
    width: 320px;
    max-height: 500px;
    background: white;
    border: 1px solid #999;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    border-radius: 8px;
    z-index: 99999;
    flex-direction: column;
    resize: both;
    overflow: hidden;
  }
  .search-header {
    background: #343a40;
    color: #fff;
    padding: 10px;
    cursor: move;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    user-select: none;
  }
  .search-body {
    flex-grow: 1;
    overflow-y: auto;
    background: #fff;
  }
  .search-item {
    padding: 8px 15px;
    border-bottom: 1px solid #f1f1f1;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    color: #333;
  }
  .search-item:hover {
    background: #e2e6ea;
  }

  #global-tooltip {
    position: fixed;
    display: none;
    background: rgba(0, 0, 0, 0.9);
    color: #fff;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 11px;
    z-index: 9999;
    pointer-events: none;
  }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 99999;
    justify-content: center;
    align-items: center;
  }
  .modal-box {
    background: #fff;
    padding: 0;
    border-radius: 8px;
    width: 800px;
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  }
  .modal-header {
    padding: 15px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
  }
  .modal-tabs {
    display: flex;
    gap: 10px;
    padding: 10px 15px;
    background: #fff;
    border-bottom: 1px solid #eee;
  }
  .mtab {
    padding: 5px 15px;
    font-size: 12px;
    border-radius: 15px;
    border: 1px solid #ddd;
    cursor: pointer;
    background: #f8f9fa;
  }
  .mtab.active {
    background: #343a40;
    color: #fff;
    border-color: #343a40;
  }
  .err-table {
    width: 100%;
    font-size: 12px;
    border-collapse: collapse;
  }
  .err-table th {
    background: #f1f3f5;
    position: sticky;
    top: 0;
  }
  .err-table th,
  .err-table td {
    border-bottom: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }

  @keyframes flash-highlight {
    0% {
      transform: scale(1.6);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
    50% {
      transform: scale(2.2);
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.8);
    }
    100% {
      transform: scale(1.6);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
  }
</style>

<div class="kho-wrapper">
  <div class="top-dashboard">
    <div class="stats-box">
      <div class="stat-mini"><b id="s-total">0</b><span>T·ªïng</span></div>
      <div class="stat-mini" style="color: #007bff">
        <b id="s-hspm">0</b><span>HSPM</span>
      </div>
      <div class="stat-mini" style="color: #6f42c1">
        <b id="s-hrc1">0</b><span>HRC1</span>
      </div>
      <div class="stat-mini" style="color: #e83e8c">
        <b id="s-hrc2">0</b><span>HRC2</span>
      </div>
      <div class="stat-mini text-danger" onclick="showModal('error')">
        <b id="s-err">0</b><span>L·ªói</span>
      </div>
    </div>
    <div class="stats-box" style="justify-content: space-between; flex: 2">
      <div
        style="display: flex; gap: 10px; font-size: 11px; align-items: center"
      >
        <div>
          <span
            style="
              display: inline-block;
              width: 10px;
              height: 10px;
              background: #28a745;
              border-radius: 50%;
            "
          ></span>
          ƒê√£ mapping SO
        </div>
        <div>
          <span
            style="
              display: inline-block;
              width: 10px;
              height: 10px;
              background: #adb5bd;
              border-radius: 50%;
            "
          ></span>
          Ch∆∞a mapping SO
        </div>
        <div>
          <span
            style="
              display: inline-block;
              width: 10px;
              height: 10px;
              background: #dc3545;
              border-radius: 50%;
            "
          ></span>
          L·ªói v·ªã tr√≠ ch√¢n ƒë·∫ø
        </div>
      </div>
      <div style="display: flex; gap: 5px">
        <input
          type="text"
          id="inpSearch"
          placeholder="Nh·∫≠p ID, SO..."
          class="form-control form-control-sm"
          style="width: 200px"
          onkeyup="if(event.key === 'Enter') doSearch()"
        />
        <button onclick="doSearch()" class="btn btn-sm btn-primary">T√¨m</button>
        <button onclick="clearSearch()" class="btn btn-sm btn-secondary">
          ‚úñ
        </button>
      </div>
    </div>
  </div>

  <div class="tab-header">
    <button class="tab-btn active" onclick="switchTab('hspm')" id="btn-hspm">
      üè¢ Kho HSPM
    </button>
    <button class="tab-btn" onclick="switchTab('hrc1')" id="btn-hrc1">
      üè≠ Kho HRC1
    </button>
    <button class="tab-btn" onclick="switchTab('hrc2')" id="btn-hrc2">
      üî• Kho HRC2 (N√≥ng)
    </button>
  </div>

  <div id="tab-hspm" class="tab-content active">
    <div class="warehouse-scroll-area">
      <div id="grid-view-hspm" class="warehouse-grid">
        <div style="text-align: center; padding: 50px">
          <div class="spinner-border text-primary"></div>
        </div>
      </div>
    </div>
  </div>
  <div id="tab-hrc1" class="tab-content">
    <div class="warehouse-scroll-area">
      <div id="grid-view-hrc1" class="warehouse-grid">
        <div style="text-align: center; padding: 50px">
          <div class="spinner-border text-info"></div>
        </div>
      </div>
    </div>
  </div>
  <div id="tab-hrc2" class="tab-content">
    <div class="warehouse-scroll-area">
      <div
        id="grid-view-hrc2"
        class="warehouse-grid"
        style="grid-template-columns: repeat(2, 1fr)"
      >
        <div style="text-align: center; padding: 50px">
          <div class="spinner-border text-danger"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="pnlResult" class="search-result-panel">
    <div id="pnlHeader" class="search-header">
      <span id="txtSearchTitle"
        >üîç K·∫øt qu·∫£ (<span id="lblMatchCount">0</span>)</span
      >
      <button
        class="btn btn-sm btn-danger"
        style="padding: 0px 6px"
        onclick="clearSearch()"
      >
        ‚úñ
      </button>
    </div>

    <div
      style="
        padding: 10px;
        background: #f8f9fa;
        text-align: center;
        border-bottom: 1px solid #eee;
      "
    >
      <button class="btn btn-sm btn-info w-100" onclick="openMatchDetail()">
        üìÑ Xem chi ti·∫øt d·∫°ng b·∫£ng
      </button>
    </div>
    <div id="lstZoneMatches" class="search-body"></div>
  </div>
</div>

<div id="global-tooltip"></div>
<div id="modalList" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header">
      <h5 id="m-title" style="margin: 0">Danh s√°ch</h5>
      <span
        style="cursor: pointer; font-size: 24px; line-height: 1"
        onclick="closeModal()"
        >&times;</span
      >
    </div>

    <div class="modal-tabs" id="modal-filter-tabs">
      <div class="mtab active" onclick="filterModal('ALL', this)">T·∫•t c·∫£</div>
      <div class="mtab" onclick="filterModal('HSPM', this)">Kho HSPM</div>
      <div class="mtab" onclick="filterModal('HRC1', this)">Kho HRC1</div>
      <div class="mtab" onclick="filterModal('HRC2', this)">Kho HRC2</div>
      <div class="mtab" onclick="filterModal('OTHER', this)">Kh√°c</div>
    </div>

    <div style="flex: 1; overflow-y: auto; padding: 0">
      <table class="err-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>V·ªã tr√≠</th>
                    <th>SO Mapping</th> 
                    <th>L·ªói / Th√¥ng tin</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="m-body"></tbody>
        </table>
    </div>
    <div
      style="
        padding: 10px;
        background: #f8f9fa;
        text-align: right;
        font-size: 11px;
        color: #666;
      "
    >
      T·ªïng c·ªông: <b id="m-count">0</b> d√≤ng
    </div>
  </div>
</div>

<script>
  const API_URL = "{{ url_for('kho2d_bp.get_data') }}";
  const ZONES_HSPM = [
    "HA1",
    "HA2",
    "HA3",
    "HB1",
    "HB2",
    "HB3",
    "HC1",
    "HC2",
    "HC3",
    "HD1",
    "HD2",
    "HD3",
  ];
  const ZONES_HRC1 = ["KA1", "KA3", "KB1", "KB2", "KB3", "KC1", "KC3"];
  const ZONES_HRC1_CONFIG = {};
  ZONES_HRC1.forEach((z) => (ZONES_HRC1_CONFIG[z] = 9));
  const ZONES_HRC2_CONFIG = {
    NA: 11,
    NB: 11,
    NC: 6,
    ND: 6,
    NE: 7,
    NF: 9,
    NG: 9,
  };
  const ZONES_HRC2 = Object.keys(ZONES_HRC2_CONFIG);

  // Bi·∫øn to√†n c·ª•c
  let G_DATA_HSPM = {},
    G_DATA_HRC1 = {},
    G_DATA_HRC2 = {};
  let G_ERR_OBJ = {}; // Ch·ª©a object l·ªói ƒë√£ chia s·∫µn: {ALL:[], HSPM:[], ...}
  let G_AUTO = [];
  let G_CURRENT_MATCHES = [];
  let CURRENT_TAB = "hspm";

  // Bi·∫øn tr·∫°ng th√°i modal
  let G_MODAL_MODE = "ERROR"; // 'ERROR' ho·∫∑c 'AUTO'

  async function init() {
    try {
      let res = await fetch(API_URL);
      let data = await res.json();

      if (data.status === "success") {
        G_DATA_HSPM = data.data_hspm;
        G_DATA_HRC1 = data.data_hrc1;
        G_DATA_HRC2 = data.data_hrc2;

        // L·∫•y Object l·ªói ƒë√£ chia t·ª´ Python (n·∫øu c√≥), kh√¥ng th√¨ fallback v·ªÅ list th∆∞·ªùng
        G_ERR_OBJ = data.errors_by_wh || {
          ALL: data.invalid,
          HSPM: [],
          HRC1: [],
          HRC2: [],
          OTHER: [],
        };
        G_AUTO = data.auto_list;

        // Render Stats
        document.getElementById("s-total").innerText = data.stats.total;
        document.getElementById("s-hspm").innerText = data.stats.hspm_count;
        document.getElementById("s-hrc1").innerText = data.stats.hrc1_count;
        document.getElementById("s-hrc2").innerText = data.stats.hrc2_count;
        document.getElementById("s-err").innerText = data.stats.invalid;

        // Render Layouts
        await renderGridGeneric(
          G_DATA_HSPM,
          ZONES_HSPM,
          "grid-view-hspm",
          10,
          null,
          true
        );
        await renderGridGeneric(
          G_DATA_HRC1,
          ZONES_HRC1,
          "grid-view-hrc1",
          10,
          ZONES_HRC1_CONFIG,
          true
        );
        await renderGridGeneric(
          G_DATA_HRC2,
          ZONES_HRC2,
          "grid-view-hrc2",
          100,
          ZONES_HRC2_CONFIG,
          false
        );

        initGlobalEvents();
        makeDraggable(document.getElementById("pnlResult"));
      }
    } catch (e) {
      console.error(e);
      alert("L·ªói t·∫£i: " + e.message);
    }
  }

  // --- LOGIC MODAL & L·ªåC L·ªñI (QUAN TR·ªåNG) ---
 // C·∫≠p nh·∫≠t l·∫°i h√†m showModal
function showModal(type, keyword = '') {
    const modal = document.getElementById('modalList');
    const tabs = document.getElementById('modal-filter-tabs');
    modal.style.display = 'flex';
    
    // Reset tabs active state
    document.querySelectorAll('.mtab').forEach(t => t.classList.remove('active'));

    if (type === 'error') {
        // --- CH·∫æ ƒê·ªò XEM L·ªñI B√åNH TH∆Ø·ªúNG (Click t·ª´ thanh Stats) ---
        G_MODAL_MODE = 'ERROR';
        document.getElementById('m-title').innerText = "Danh s√°ch L·ªói (Theo Kho)";
        tabs.style.display = 'flex'; // Hi·ªán tabs l·ªçc kho
        
        // M·∫∑c ƒë·ªãnh ch·ªçn tab ALL
        filterModal('ALL', document.querySelector('.mtab:first-child'));
    } 
    else if (type === 'SEARCH_ERR') {
        // --- CH·∫æ ƒê·ªò XEM K·∫æT QU·∫¢ T√åM KI·∫æM (M·ªöI TH√äM) ---
        G_MODAL_MODE = 'SEARCH_ERR';
        document.getElementById('m-title').innerHTML = `K·∫øt qu·∫£ t√¨m l·ªói cho: "<span style="color:red">${keyword}</span>"`;
        tabs.style.display = 'none'; // ·∫®n tabs l·ªçc kho v√¨ ƒëang l·ªçc theo t·ª´ kh√≥a
        
        // Logic l·ªçc d·ªØ li·ªáu gi·ªëng h·ªát h√†m doSearch ƒë·ªÉ ƒë·∫£m b·∫£o s·ªë l∆∞·ª£ng kh·ªõp nhau
        let filteredList = [];
        if (G_ERR_OBJ && G_ERR_OBJ['ALL']) {
            filteredList = G_ERR_OBJ['ALL'].filter(item => {
                let matchID = item.id && item.id.toUpperCase().includes(keyword);
                let matchSO = item.so && item.so.toUpperCase().includes(keyword); // T√¨m theo SO
                let matchPos = item.pos && item.pos.toUpperCase().includes(keyword);
                return matchID || matchSO || matchPos;
            });
        }
        
        // V·∫Ω l·∫°i b·∫£ng v·ªõi danh s√°ch ƒë√£ l·ªçc
        renderModalList(filteredList);
    }
    else {
        // --- CH·∫æ ƒê·ªò AUTO (Gi·ªØ nguy√™n) ---
        G_MODAL_MODE = 'AUTO';
        document.getElementById('m-title').innerText = "Danh s√°ch G·ª£i √Ω (Auto)";
        tabs.style.display = 'none';
        renderModalList(G_AUTO);
    }
}

  function filterModal(filterKey, btnElement) {
    // Active UI
    document
      .querySelectorAll(".mtab")
      .forEach((t) => t.classList.remove("active"));
    if (btnElement) btnElement.classList.add("active");

    // Logic L·ªçc: L·∫•y tr·ª±c ti·∫øp t·ª´ Object Backend g·ª≠i v·ªÅ
    // filterKey kh·ªõp v·ªõi: 'ALL', 'HSPM', 'HRC1', 'HRC2', 'OTHER'
    let listToShow = G_ERR_OBJ[filterKey] || [];

    renderModalList(listToShow);
  }

 function renderModalList(list) {
    let html = list.map(i => `<tr>
        <td>${i.id}</td>
        
        <td><b>${i.pos}</b></td>
        
        <td style="color:#007bff; font-weight:bold">
            ${i.so ? i.so : '<span style="color:#ccc">-</span>'}
        </td>

        <td>${i.reason || 'L·ªói'}</td>
        
        <td>-</td>
    </tr>`).join('');
    
    // L∆∞u √Ω: colspan="5" v√¨ b√¢y gi·ªù b·∫£ng ƒë√£ c√≥ 5 c·ªôt
    document.getElementById('m-body').innerHTML = html || '<tr><td colspan="5" style="text-align:center;color:#999">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
    document.getElementById('m-count').innerText = list.length;
}
  // --- C√ÅC H√ÄM C≈® GI·ªÆ NGUY√äN ---
  function closeModal() {
    document.getElementById("modalList").style.display = "none";
  }

  // (ƒê·ªÉ g·ªçn code, t√¥i vi·∫øt t√≥m t·∫Øt l·∫°i c√°c h√†m ph·ª• tr·ª£ b√™n d∆∞·ªõi, b·∫°n copy ƒë·∫ßy ƒë·ªß nh√©)
  async function renderGridGeneric(
    mapData,
    zoneList,
    containerId,
    defaultMaxCells,
    zoneConfig,
    enableSafetyCheck
  ) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    for (const zone of zoneList) {
      let zData = mapData[zone] || {};
      let maxLine = 10;
      if (zoneConfig && zoneConfig[zone]) maxLine = zoneConfig[zone];
      else
        Object.keys(zData).forEach((k) => {
          if (parseInt(k) > maxLine) maxLine = parseInt(k);
        });
      let zoneHtml = `<div class="zone-card" id="zone-${zone}"><div class="zone-title">${zone}</div>`;
      for (let i = 1; i <= maxLine; i++) {
        let lData = zData[i] || { fixed: {}, pending: [] };
        zoneHtml += `<div class="line-row"><div class="line-name">${i}</div><div class="pyramid-container">${buildPyramid(
          lData,
          defaultMaxCells,
          enableSafetyCheck
        )}</div></div>`;
      }
      zoneHtml += `</div>`;
      container.insertAdjacentHTML("beforeend", zoneHtml);
      if (zoneList.length > 5) await new Promise((r) => setTimeout(r, 0));
    }
  }

  // --- H√ÄM V·∫º KIM T·ª∞ TH√ÅP (ƒê√É S·ª¨A LOGIC X·∫æP T·∫¶NG THEO SUFFIX 'X') ---
  // --- H√ÄM V·∫º KIM T·ª∞ TH√ÅP (ƒê√É UPDATE LOGIC CHECK CH√ÇN ƒê·∫æ CHU·∫®N) ---
  function buildPyramid(lData, maxCellsRef, checkStructuralIntegrity) {
    let fixed = lData.fixed || {};
    let pending = lData.pending || [];

    // 1. T√ÅCH D·ªÆ LI·ªÜU RA C√ÅC T·∫¶NG RI√äNG BI·ªÜT
    let mapT1 = {}; // T·∫ßng 1: S·ªë L·∫ª (1, 3, 5...)
    let mapT2 = {}; // T·∫ßng 2: S·ªë Ch·∫µn (2, 4, 6...)
    let mapT3 = {}; // T·∫ßng 3: C√≥ ƒëu√¥i X (ho·∫∑c quy ∆∞·ªõc ri√™ng)

    let maxIdFound = 0;

    Object.keys(fixed).forEach((key) => {
      let num = parseInt(key);
      if (!isNaN(num)) {
        if (num > maxIdFound) maxIdFound = num;

        // LOGIC PH√ÇN T·∫¶NG M·ªöI (FIX L·ªñI M·∫§T T·∫¶NG 2)
        if (key.toUpperCase().endsWith("X")) {
          mapT3[num] = fixed[key]; // ƒêu√¥i X -> T·∫ßng 3
        } else if (num % 2 === 0) {
          mapT2[num] = fixed[key]; // S·ªë Ch·∫µn -> T·∫ßng 2
        } else {
          mapT1[num] = fixed[key]; // S·ªë L·∫ª -> T·∫ßng 1
        }
      }
    });

    // 2. T√çNH TO√ÅN S·ªê L∆Ø·ª¢NG √î C·∫¶N V·∫º
    let countT1 = 0;
    if (maxCellsRef > 50) {
      // Kho HRC2: V·∫Ω theo th·ª±c t·∫ø
      countT1 = Math.max(10, Math.ceil(maxIdFound / 2) + 2);
    } else {
      // Kho HSPM/HRC1: V·∫Ω chu·∫©n th√°p
      let slotsNeeded = Math.ceil(maxIdFound / 2);
      if (pending.length > 0) slotsNeeded += pending.length;
      countT1 = Math.max(15, slotsNeeded + 2);
    }

    let countT2 = countT1 - 1;
    let countT3 = countT1 - 2;

    // 3. H√ÄM V·∫º T·ª™NG D√íNG (C√ì THAM S·ªê supportMap ƒê·ªÇ CHECK CH√ÇN ƒê·∫æ)
    const drawRow = (
      tierName,
      startNum,
      count,
      marginClass,
      currentMap,
      supportMap
    ) => {
      let rowHtml = `<div class="tier ${marginClass}">`;
      for (let k = 0; k < count; k++) {
        let num = startNum + k * 2;

        let item = currentMap[num];

        let css = "empty";
        let shortId = "";
        let isErr = false;
        let isAuto = false;

        // --- LOGIC CHECK CH√ÇN ƒê·∫æ (SAFETY) ---
        // Nguy√™n l√Ω: Cu·ªôn ·ªü v·ªã tr√≠ N c·∫ßn 2 cu·ªôn ·ªü t·∫ßng d∆∞·ªõi l√† (N-1) v√† (N+1) ƒë·ª° n√≥.
        if (checkStructuralIntegrity && item && supportMap) {
          // L·∫•y 2 ch√¢n ƒë·ªÉ ·ªü t·∫ßng d∆∞·ªõi
          let legLeft = supportMap[num - 1];
          let legRight = supportMap[num + 1];

          // N·∫øu thi·∫øu 1 trong 2 ch√¢n -> L·ªói treo l∆° l·ª≠ng
          if (!legLeft || !legRight) {
            isErr = true;
          }
        }

        if (item) {
          shortId = item[0].slice(-4);
          if (item[5] === true) isAuto = true;

          if (isErr) css = "error"; // ∆Øu ti√™n hi·ªÉn th·ªã l·ªói ƒë·ªè
          else if (isAuto) css = "auto";
          else if (item[4] && item[4] != "") css = "ok";
          else css = "empty-so";
        } else if (tierName === "T1" && pending.length > 0) {
          // Auto fill cho T·∫ßng 1
          item = pending.shift();
          shortId = item[0].slice(-4);
          css = "auto";
          isAuto = true;
        } else {
          shortId = `<span style="opacity:0.1;font-size:6px">.</span>`;
        }

        // Data Attribute
        let dataStr = "";
        if (item) {
          dataStr = JSON.stringify({
            id: item[0],
            pos: item[1],
            w: item[2],
            so: item[4],
            tier: tierName,
            zone: item[1].substring(0, 3),
            isErr: isErr,
            isAuto: isAuto,
          }).replace(/"/g, "&quot;");
        }

        rowHtml += `<div class="coil ${css}" data-info="${dataStr}">${shortId}</div>`;
      }
      rowHtml += `</div>`;
      return rowHtml;
    };

    // 4. G·ªåI H√ÄM V·∫º V·ªöI THAM S·ªê SUPPORT MAP
    // T·∫ßng 3 (Check d·ª±a v√†o mapT2)
    let htmlT3 = drawRow("T3", 3, countT3, "t3", mapT3, mapT2);

    // T·∫ßng 2 (Check d·ª±a v√†o mapT1)
    let htmlT2 = drawRow("T2", 2, countT2, "t2", mapT2, mapT1);

    // T·∫ßng 1 (Kh√¥ng c·∫ßn check ch√¢n ƒë·∫ø v√¨ n·∫±m d∆∞·ªõi ƒë·∫•t -> supportMap = null)
    let htmlT1 = drawRow("T1", 1, countT1, "t1", mapT1, null);

    return htmlT3 + htmlT2 + htmlT1;
  }
  function smoothScrollTo(element) {
    if (!element) return;
    let container = element.closest(".warehouse-scroll-area");
    if (container) {
      let targetTop = element.offsetTop - 20;
      container.scrollTo({ top: targetTop, behavior: "smooth" });
    }
  }
  function makeDraggable(elmnt) {
    var pos1 = 0,
      pos2 = 0,
      pos3 = 0,
      pos4 = 0;
    if (document.getElementById("pnlHeader")) {
      document.getElementById("pnlHeader").onmousedown = dragMouseDown;
    } else {
      elmnt.onmousedown = dragMouseDown;
    }
    function dragMouseDown(e) {
      e = e || window.event;
      e.preventDefault();
      pos3 = e.clientX;
      pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      document.onmousemove = elementDrag;
    }
    function elementDrag(e) {
      e = e || window.event;
      e.preventDefault();
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      elmnt.style.top = elmnt.offsetTop - pos2 + "px";
      elmnt.style.left = elmnt.offsetLeft - pos1 + "px";
      elmnt.style.right = "auto";
    }
    function closeDragElement() {
      document.onmouseup = null;
      document.onmousemove = null;
    }
  }
  function switchTab(tabName) {
    CURRENT_TAB = tabName;
    document
      .querySelectorAll(".tab-btn")
      .forEach((b) => b.classList.remove("active"));
    document.getElementById("btn-" + tabName).classList.add("active");
    document
      .querySelectorAll(".tab-content")
      .forEach((c) => c.classList.remove("active"));
    document.getElementById("tab-" + tabName).classList.add("active");
  }
function doSearch() {
    let kw = document.getElementById('inpSearch').value.toUpperCase().trim();
    if(!kw) { clearSearch(); return; }

    // 1. Reset tr·∫°ng th√°i c≈©
    document.querySelectorAll('.warehouse-scroll-area').forEach(el => el.classList.add('is-filtering'));
    document.querySelectorAll('.match').forEach(e => e.classList.remove('match'));
    G_CURRENT_MATCHES = [];
    
    let count = 0;
    let zoneStats = {}; 

    // --- PH·∫¶N 1: T√åM TR√äN S∆† ƒê·ªí (ƒê√£ c√≥) ---
    const allCoils = document.querySelectorAll('.coil[data-info]');
    allCoils.forEach(el => {
        let infoStr = el.getAttribute('data-info');
        if(infoStr.toUpperCase().includes(kw)) {
            el.classList.add('match');
            count++;
            try {
                let data = JSON.parse(infoStr);
                let zName = data.zone || 'Kh√°c';
                if(!zoneStats[zName]) zoneStats[zName] = 0;
                zoneStats[zName]++;
                
                let tabId = 'hspm';
                if (el.closest('#grid-view-hrc1')) tabId = 'hrc1';
                else if (el.closest('#grid-view-hrc2')) tabId = 'hrc2';
                
                G_CURRENT_MATCHES.push({...data, zone: zName, tab: tabId, element: el, type: 'valid'});
            } catch(e){}
        }
    });

    // --- PH·∫¶N 2: T√åM TRONG DANH S√ÅCH L·ªñI (M·ªöI TH√äM) ---
    // G_ERR_OBJ['ALL'] ch·ª©a t·∫•t c·∫£ c√°c cu·ªôn l·ªói
    if (G_ERR_OBJ && G_ERR_OBJ['ALL']) {
        G_ERR_OBJ['ALL'].forEach(errItem => {
            // Ki·ªÉm tra ID ho·∫∑c SO c√≥ ch·ª©a t·ª´ kh√≥a kh√¥ng
            let matchID = errItem.id && errItem.id.toUpperCase().includes(kw);
            let matchSO = errItem.so && errItem.so.toUpperCase().includes(kw);
            let matchPos = errItem.pos && errItem.pos.toUpperCase().includes(kw);

            if (matchID || matchSO || matchPos) {
                count++;
                let zName = "L·ªñI"; // Gom v√†o nh√≥m L·ªói
                if(!zoneStats[zName]) zoneStats[zName] = 0;
                zoneStats[zName]++;

                // Push v√†o danh s√°ch k·∫øt qu·∫£, ƒë√°nh d·∫•u type='error'
                G_CURRENT_MATCHES.push({
                    id: errItem.id, 
                    pos: errItem.pos, 
                    so: errItem.so, 
                    zone: 'L·ªói', 
                    tab: 'error', // Tab ·∫£o
                    type: 'error', // ƒê√°nh d·∫•u l√† l·ªói
                    reason: errItem.reason
                });
            }
        });
    }

    if(count === 0) { alert("Kh√¥ng t√¨m th·∫•y!"); clearSearch(); return; }

    // Hi·ªÉn th·ªã k·∫øt qu·∫£
    let displayKw = kw.length > 15 ? kw.substring(0, 15) + "..." : kw;
    document.getElementById('txtSearchTitle').innerHTML = `üîç "${displayKw}" (<span id="lblMatchCount">${count}</span>)`;
    
    let html = '';
    for (const [zone, qty] of Object.entries(zoneStats)) {
        let color = '#007bff';
        let targetTab = 'hspm';
        
        if (zone.startsWith('K')) { color = '#6f42c1'; targetTab = 'hrc1'; }
        else if (zone.startsWith('N')) { color = '#e83e8c'; targetTab = 'hrc2'; }
        else if (zone === 'L·ªñI') { color = '#dc3545'; targetTab = 'error'; } // M√†u ƒë·ªè cho l·ªói

        html += `<div class="search-item" onclick="handleResultClick('${targetTab}', '${zone}')">
                    <b>${zone}</b>
                    <span style="color:${color};font-weight:bold">${qty} cu·ªôn &rarr;</span>
                 </div>`;
    }
    document.getElementById('lstZoneMatches').innerHTML = html;
    document.getElementById('pnlResult').style.display = 'flex';
}

// H√†m x·ª≠ l√Ω click m·ªõi (thay th·∫ø jumpToZoneInTab c≈© ƒë·ªÉ x·ª≠ l√Ω c·∫£ tr∆∞·ªùng h·ª£p l·ªói)
function handleResultClick(tabId, zoneName) {
    if (tabId === 'error') {
        // L·∫•y t·ª´ kh√≥a ƒëang nh·∫≠p trong √¥ t√¨m ki·∫øm
        let kw = document.getElementById('inpSearch').value.toUpperCase().trim();
        
        // M·ªü Modal v·ªõi ch·∫ø ƒë·ªô 'SEARCH_ERR' v√† truy·ªÅn t·ª´ kh√≥a v√†o
        showModal('SEARCH_ERR', kw); 
    } else {
        // N·∫øu l√† kho th∆∞·ªùng -> Nh·∫£y ƒë·∫øn v·ªã tr√≠ v·∫Ω
        jumpToZoneInTab(zoneName, tabId);
    }
}
  function clearSearch() {
    document
      .querySelectorAll(".warehouse-scroll-area")
      .forEach((el) => el.classList.remove("is-filtering"));
    document
      .querySelectorAll(".match")
      .forEach((e) => e.classList.remove("match"));
    document.getElementById("pnlResult").style.display = "none";
    document.getElementById("inpSearch").value = "";
    document.getElementById("txtSearchTitle").innerHTML =
      'üîç K·∫øt qu·∫£ (<span id="lblMatchCount">0</span>)';
  }
  function jumpToZoneInTab(zoneName, tabId) {
    if (CURRENT_TAB !== tabId) switchTab(tabId);
    setTimeout(() => {
      let el = document.getElementById("zone-" + zoneName);
      smoothScrollTo(el);
    }, 100);
  }
function openMatchDetail() {
    // 1. Hi·ªÉn th·ªã UI Modal
    document.getElementById('modalList').style.display = 'flex';
    document.getElementById('m-title').innerText = "Chi ti·∫øt t√¨m ki·∫øm";
    
    // ·∫®n thanh tab l·ªçc kho v√¨ ƒë√¢y l√† b·∫£ng k·∫øt qu·∫£ t√¨m ki·∫øm h·ªón h·ª£p
    document.getElementById('modal-filter-tabs').style.display = 'none';

    // 2. Render d·ªØ li·ªáu t·ª´ G_CURRENT_MATCHES (ƒë√£ ch·ª©a c·∫£ Valid v√† Error)
    let html = G_CURRENT_MATCHES.map((item, index) => {
        let locationInfo = '';
        let actionBtn = '';
        let rowClass = '';

        if (item.type === 'error') {
            // --- TR∆Ø·ªúNG H·ª¢P L·ªñI ---
            rowClass = 'style="background-color: #fff5f5"'; // N·ªÅn h∆°i ƒë·ªè
            
            // C·ªôt th√¥ng tin: Hi·ªÉn th·ªã l√Ω do l·ªói
            locationInfo = `<span style="color:#dc3545; font-size:11px">
                                ‚ö† ${item.reason || 'L·ªói v·ªã tr√≠'}
                            </span>`;
            
            // N√∫t h√†nh ƒë·ªông: M·ªü Modal L·ªói l·ªçc theo ID n√†y
            // L∆∞u √Ω: d√πng item.id ƒë·ªÉ filterModal ch·ªâ hi·ªán ƒë√∫ng d√≤ng n√†y
            actionBtn = `<button class="btn btn-sm btn-danger" 
                                 onclick="showModal('SEARCH_ERR', '${item.id}')">
                                 XEM L·ªñI
                         </button>`;
        } else {
            // --- TR∆Ø·ªúNG H·ª¢P H·ª¢P L·ªÜ (V·∫Ω ƒë∆∞·ª£c) ---
            
            // C·ªôt th√¥ng tin: Hi·ªÉn th·ªã t√™n kho
            locationInfo = `Kho: <b>${item.tab.toUpperCase()}</b>`;
            
            // N√∫t h√†nh ƒë·ªông: Nh·∫£y ƒë·∫øn v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì
            actionBtn = `<button class="btn btn-sm btn-primary" 
                                 onclick="jumpToCoil(${index})">
                                 ƒê·∫æN
                         </button>`;
        }

        return `<tr ${rowClass}>
            <td><b>${item.id}</b></td>
            <td>${item.pos}</td>
            
            <td style="color:#007bff; font-weight:bold">
                ${item.so || '<span style="color:#ccc">-</span>'}
            </td>
            
            <td>${locationInfo}</td>
            
            <td>${actionBtn}</td>
        </tr>`;
    }).join('');

    // 3. G√°n HTML v√†o b·∫£ng
    // L∆∞u √Ω: ƒê·∫£m b·∫£o b·∫£ng HTML c·ªßa b·∫°n ƒë√£ c√≥ ƒë·ªß 5 c·ªôt (ID, Pos, SO, Info, Action)
    document.getElementById('m-body').innerHTML = html;
    document.getElementById('m-count').innerText = G_CURRENT_MATCHES.length;
}
  function jumpToCoil(index) {
    closeModal();
    document.getElementById("modal-filter-tabs").style.display = "flex";
    let item = G_CURRENT_MATCHES[index];
    if (CURRENT_TAB !== item.tab) switchTab(item.tab);
    setTimeout(() => {
      let target = item.element;
      if (target) {
        smoothScrollTo(target);
        target.style.animation = "none";
        target.offsetHeight;
        target.style.animation = "flash-highlight 1.5s ease-in-out";
      }
    }, 150);
  }
  function initGlobalEvents() {
    const tooltip = document.getElementById("global-tooltip");
    document.querySelectorAll(".warehouse-scroll-area").forEach((c) => {
      c.addEventListener("mouseover", (e) => {
        const coil = e.target.closest(".coil");
        if (!coil) {
          tooltip.style.display = "none";
          return;
        }
        const infoStr = coil.getAttribute("data-info");
        if (!infoStr) return;
        const data = JSON.parse(infoStr);
        let wFmt = data.w
          ? parseFloat(data.w.replace(/,/g, "")).toLocaleString()
          : "0";
        tooltip.innerHTML = `<b>${data.id}</b><br>V·ªã tr√≠: ${
          data.pos
        }<br>KL: ${wFmt} kg<br>SO: ${data.so || "Tr·ªëng"} ${
          data.isErr ? '<br><b style="color:#ffadad">‚ö† THI·∫æU CH√ÇN ƒê·∫æ</b>' : ""
        } ${data.isAuto ? '<br><i style="color:#fd7e14">G·ª£i √Ω x·∫øp</i>' : ""}`;
        tooltip.style.display = "block";
      });
      c.addEventListener("mousemove", (e) => {
        if (tooltip.style.display === "block") {
          tooltip.style.top = e.clientY + 15 + "px";
          tooltip.style.left = e.clientX + 15 + "px";
        }
      });
      c.addEventListener("mouseout", () => (tooltip.style.display = "none"));
    });
  }

  init();
</script>
{% endblock %}
