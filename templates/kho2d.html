<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Sơ Đồ Kho Thông Minh (Smart Warehouse)</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #eef2f5; padding: 20px; min-width: 1200px; }
        
        /* --- HEADER & DASHBOARD --- */
        .top-bar { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;}
        
        .stats-card {
            background: #fff; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; gap: 20px; align-items: center; flex: 1;
        }
        .stat-item { text-align: center; }
        .stat-val { font-size: 22px; font-weight: bold; color: #333; display: block; }
        .stat-label { font-size: 11px; color: #666; text-transform: uppercase; }
        
        .text-success { color: #28a745; }
        .text-warning { color: #fd7e14; }
        .text-danger { color: #dc3545; }
        
        .clickable { cursor: pointer; transition: transform 0.2s; position: relative; }
        .clickable:hover { transform: scale(1.1); }
        .clickable:hover .stat-val { text-decoration: underline; }

        .search-box {
            background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; gap: 10px; align-items: center;
        }
        .search-input { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; width: 200px; outline: none;}
        
        /* Nút tìm kiếm màu xanh dương cho dễ nhận diện */
        .btn-search { background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;}
        .btn-search:hover { background: #0056b3; }

        /* --- LEGEND (CHÚ THÍCH) --- */
        .legend { background: #fff; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px; font-size: 13px;}
        .sample-box { width: 16px; height: 16px; border: 1px solid #ccc; display: inline-block; vertical-align: middle; border-radius: 50%; margin-right: 4px;}
        
        /* MÀU SẮC CHÚ THÍCH */
        .green { background: #28a745; } /* Có SO */
        .gray-coil { background: #adb5bd; } /* Chưa SO  */
        .orange { background: #fd7e14; animation: pulse-orange 2s infinite; } /* Gợi ý */
        .red { background: #dc3545; } /* Lỗi */
        .yellow-search { background: #ffeb3b; border: 2px solid #ff9800; } /* Tìm kiếm  */

        @keyframes pulse-orange {
            0% { box-shadow: 0 0 0 0 rgba(253, 126, 20, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(253, 126, 20, 0); }
            100% { box-shadow: 0 0 0 0 rgba(253, 126, 20, 0); }
        }

        /* --- WAREHOUSE LAYOUT --- */
        .warehouse-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 50px;}
        .zone-card { background: #fff; padding: 10px; border-radius: 8px; border-top: 4px solid #0056b3; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .zone-title { font-weight: bold; text-align: center; margin-bottom: 10px; background: #f8f9fa; padding: 5px; }
        
        .line-container { display: flex; border-bottom: 1px dashed #eee; padding: 6px 0; align-items: flex-end; }
        .line-label { min-width: 30px; font-weight: bold; color: #d63384; font-size: 12px; }
        
        .coils-wrapper { display: flex; flex-direction: column; align-items: flex-start; }
        .tier-row { display: flex; height: 26px; margin-bottom: -2px; }
        .tier-row.t3 { margin-left: 26px; }
        .tier-row.t2 { margin-left: 13px; }
        .tier-row.t1 { margin-left: 0px; }

        .coil-box {
            width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 50%; 
            background: #fff; margin-right: 2px;
            display: flex; align-items: center; justify-content: center;
            font-size: 8px; font-weight: bold; color: #999;
            cursor: pointer; position: relative; transition: all 0.2s;
        }
        .coil-box:hover { transform: scale(1.4); z-index: 100; border-color: #333; }
        
        /* --- CÁC TRẠNG THÁI MÀU SẮC CUỘN --- */
        
        /* 1. Xanh: Đã Map SO */
        .coil-box.occupied { 
            background: radial-gradient(circle at 30% 30%, #28a745, #1e7e34); 
            color: #fff; border: 1px solid #155724; 
        }

        /* 2. Xám: Chưa Map SO (Unmapped) - MỚI */
        .coil-box.unmapped { 
            background: radial-gradient(circle at 30% 30%, #ced4da, #6c757d); 
            color: #fff; border: 1px solid #495057; 
        }

        /* 3. Cam: Gợi ý (Auto) */
        .coil-box.suggestion { 
            background: radial-gradient(circle at 30% 30%, #fd7e14, #e65100); 
            color: #fff; border: 1px solid #e65100; 
        }
        
        /* 4. Đỏ: Lỗi */
        .coil-box.danger { background: #dc3545; animation: blink 1s infinite; color: white;}

        /* 5. Vàng: Highlight Tìm Kiếm - MỚI */
        .coil-box.highlight { 
            background: #ffeb3b !important; 
            color: #000 !important; 
            border: 3px solid #ff9800 !important; 
            transform: scale(1.5); z-index: 200; 
            box-shadow: 0 0 15px #ffeb3b; /* Phát sáng */
        }

        @keyframes blink { 50% { opacity: 0.6; } }

        .tooltip-info {
            display: none; position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); color: #fff; padding: 8px; border-radius: 4px;
            font-size: 11px; white-space: nowrap; z-index: 1000; text-align: left; min-width: 150px;
        }
        .coil-box:hover .tooltip-info { display: block; }
        
        /* MODAL */
        .modal {
            display: none; position: fixed; z-index: 9999; left: 0; top: 0;
            width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.6);
            align-items: center; justify-content: center;
        }
        .modal.active { display: flex !important; }

        .modal-content {
            background-color: #fff; padding: 20px; border-radius: 8px;
            width: 90%; max-width: 900px; max-height: 85vh;
            display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .close-btn { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .close-btn:hover { color: #000; }
        
        .error-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px;}
        .error-table th, .error-table td { border: 1px solid #ddd; padding: 8px; }
        .error-table th { background-color: #f2f2f2; position: sticky; top: 0; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="stats-card">
        <div class="stat-item"><span class="stat-val" id="stat-total">0</span><span class="stat-label">Tổng</span></div>
        <div class="stat-item"><span class="stat-val text-success" id="stat-valid">0</span><span class="stat-label">Cố định</span></div>
        
        <div class="stat-item clickable" onclick="openListModal('auto')" title="Xem danh sách gợi ý">
            <span class="stat-val text-warning" id="stat-auto">0</span>
            <span class="stat-label">Gợi ý (Xem List)</span>
        </div>

        <div class="stat-item clickable" onclick="openListModal('error')" title="Xem danh sách lỗi">
            <span class="stat-val text-danger" id="stat-invalid">0</span>
            <span class="stat-label">Lỗi (Xem List)</span>
        </div>
    </div>
    
    <div class="search-box">
        <input type="text" id="searchInput" class="search-input" placeholder="Tìm ID / SO...">
        <button class="btn-search" onclick="handleSearch()">Tìm Kiếm</button>
    </div>

    <div class="legend">
        <span><div class="sample-box green"></div> Có SO</span>
        <span><div class="sample-box gray-coil"></div> Chưa SO </span>
        <span><div class="sample-box orange"></div> Gợi ý</span>
        <span><div class="sample-box red"></div> Lỗi</span>
        <span><div class="sample-box yellow-search"></div> Đang tìm </span>
    </div>
</div>

<div id="loading" style="text-align:center; padding: 20px;">Đang tải dữ liệu...</div>
<div id="warehouse-view" class="warehouse-container"></div>

<div id="listModal" class="modal">
    <div class="modal-content">
        <div class="modal-header" style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding-bottom:10px;">
            <h3 id="modalTitle" style="margin:0; color:#333">Danh Sách</h3>
            <span class="close-btn" onclick="closeListModal()">&times;</span>
        </div>
        <div class="modal-body" style="overflow-y:auto; margin-top:10px;">
            <table class="error-table">
                <thead>
                    <tr>
                        <th>ID Cuộn</th>
                        <th>Vị Trí Gốc</th>
                        <th>SO Mapping</th>
                        <th id="colReasonHeader">Ghi Chú</th>
                    </tr>
                </thead>
                <tbody id="listTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const ZONE_ORDER = ["HA1", "HA2", "HA3", "HB1", "HB2", "HB3", "HC1", "HC2", "HC3", "HD1", "HD2", "HD3"];
    const WAREHOUSE_CONFIG = {
        "HA1": 9, "HA2": 9, "HA3": 4, "HB1": 9, "HB2": 9, "HB3": 9,
        "HC1": 10, "HC2": 10, "HC3": 10, "HD1": 10, "HD2": 10, "HD3": 10
    };
    const MAX_POS_PER_LINE = 15;
    const API_URL = "{{ url_for('kho2d_bp.get_data') }}"; 
    
    let GLOBAL_INVALID_LIST = [];
    let GLOBAL_AUTO_LIST = [];

    async function loadData() {
        try {
            const res = await fetch(API_URL);
            const json = await res.json();
            document.getElementById('loading').style.display = 'none';
            
            if (json.status === 'success') {
                document.getElementById('stat-total').innerText = json.stats.total;
                document.getElementById('stat-valid').innerText = json.stats.valid;
                document.getElementById('stat-auto').innerText = json.stats.auto_assigned;
                document.getElementById('stat-invalid').innerText = json.stats.invalid;
                
                GLOBAL_INVALID_LIST = json.invalid || [];
                GLOBAL_AUTO_LIST = json.auto_list || [];
                
                renderWarehouse(json.data);
            }
        } catch (e) { 
            console.error(e); 
            document.getElementById('loading').innerText = "Lỗi kết nối!";
        }
    }

    // --- MODAL FUNCTION ---
    function openListModal(type) {
        const modal = document.getElementById('listModal');
        const tbody = document.getElementById('listTableBody');
        const title = document.getElementById('modalTitle');
        const colHeader = document.getElementById('colReasonHeader');

        tbody.innerHTML = '';
        let dataList = [];

        if (type === 'error') {
            title.innerText = "Danh Sách Lỗi Vị Trí";
            title.style.color = "#dc3545"; 
            colHeader.innerText = "Lý Do Lỗi";
            dataList = GLOBAL_INVALID_LIST;
        } else if (type === 'auto') {
            title.innerText = "Danh Sách Gợi Ý (Tự động điền)";
            title.style.color = "#fd7e14"; 
            colHeader.innerText = "Trạng Thái";
            dataList = GLOBAL_AUTO_LIST;
        }

        if (!dataList || dataList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Không có dữ liệu.</td></tr>';
        } else {
            dataList.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:bold; color:#0056b3">${item.id}</td>
                    <td>${item.pos}</td>
                    <td>${item.so}</td>
                    <td style="${type==='error'?'color:red':'color:#fd7e14'}">${item.reason}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        modal.classList.add('active');
    }

    function closeListModal() { document.getElementById('listModal').classList.remove('active'); }
    window.onclick = function(e) { if (e.target == document.getElementById('listModal')) closeListModal(); }

    // --- RENDER ---
    function renderWarehouse(realData) {
        const container = document.getElementById('warehouse-view');
        container.innerHTML = '';
        ZONE_ORDER.forEach(zoneName => {
            const totalLines = WAREHOUSE_CONFIG[zoneName];
            if (!totalLines) return;
            const zoneDiv = document.createElement('div');
            zoneDiv.className = 'zone-card';
            let html = `<div class="zone-title">${zoneName}</div>`;
            for (let i = 1; i <= totalLines; i++) {
                const lineData = (realData[zoneName] && realData[zoneName][i]) ? realData[zoneName][i] : {fixed:{}, pending:[]};
                html += `<div class="line-container">
                            <div class="line-label">L${i}</div>
                            <div class="coils-wrapper">${renderPyramidLayers(lineData)}</div>
                         </div>`;
            }
            zoneDiv.innerHTML = html;
            container.appendChild(zoneDiv);
        });
    }

    function renderPyramidLayers(lineData) {
        let fixedItems = lineData.fixed || {};
        let pendingList = lineData.pending ? [...lineData.pending] : [];

        function getAutoItem() { return pendingList.length > 0 ? pendingList.shift() : null; }

        let t3 = '<div class="tier-row t3"><span class="tier-label">T3</span>';
        for (let k = 0; k < MAX_POS_PER_LINE; k++) {
            let s = (3 + k * 2).toString().padStart(2, '0') + 'X'; 
            let item = fixedItems[s];
            let supL = (2 + k*2).toString().padStart(3,'0');
            let supR = (2 + (k+1)*2).toString().padStart(3,'0');
            let isDanger = item && (!fixedItems[supL] || !fixedItems[supR]);
            t3 += createCoilBox(s, item, "T3", isDanger);
        }
        t3 += '</div>';

        let t2 = '<div class="tier-row t2"><span class="tier-label">T2</span>';
        for (let k = 0; k < MAX_POS_PER_LINE; k++) {
            let s = (2 + k * 2).toString().padStart(3, '0');
            let item = fixedItems[s];
            let supL = (1 + k*2).toString().padStart(3,'0');
            let supR = (1 + (k+1)*2).toString().padStart(3,'0');
            let isDanger = item && (!fixedItems[supL] || !fixedItems[supR]);
            t2 += createCoilBox(s, item, "T2", isDanger);
        }
        t2 += '</div>';

        let t1 = '<div class="tier-row t1"><span class="tier-label">T1</span>';
        for (let k = 0; k < MAX_POS_PER_LINE; k++) {
            let s = (1 + k * 2).toString().padStart(3, '0');
            let item = fixedItems[s];
            if (!item) item = getAutoItem(); 
            t1 += createCoilBox(s, item, "T1", false);
        }
        t1 += '</div>';

        return t3 + t2 + t1;
    }

    function createCoilBox(suffix, item, tierName, isDanger) {
        if (!item) return `<div class="coil-box empty"><span style="opacity:0.3;font-size:8px">${suffix}</span></div>`;

        let css = '';
        let statusHeader = '';

        // --- LOGIC MÀU SẮC MỚI ---
        if (isDanger) {
            css = 'danger'; // Đỏ (Lỗi chân)
            statusHeader = '<b style="color:#ffadad; font-size:12px">⚠ THIẾU CHÂN ĐẾ</b>';
        } 
        else if (item.is_auto) {
            css = 'suggestion'; // Cam (Gợi ý)
            statusHeader = '<b style="color:#ffcc80; font-size:12px">⚠ GỢI Ý (Auto)</b>';
        } 
        else {
            // Check SO: Nếu có SO và độ dài > 0 -> XANH, ngược lại -> XÁM
            if (item.so && item.so.length > 0) {
                css = 'occupied'; // Xanh
                statusHeader = `<b style="color:#80ff80; font-size:12px">✔ ${item.pos}</b>`;
            } else {
                css = 'unmapped'; // Xám (Chưa Map)
                statusHeader = `<b style="color:#dee2e6; font-size:12px">⚠ ${item.pos} (Chưa Map)</b>`;
            }
        }

        let shortId = item.id.includes('-') ? item.id.split('-').pop() : item.id.slice(-4);
        let displaySO = (item.so && item.so.length > 0) ? item.so : '<span style="color:#ffc107">Chưa có SO</span>';

        return `
            <div class="coil-box ${css}" 
                 data-id="${item.id}" 
                 data-so="${item.so}">
                ${shortId}
                <div class="tooltip-info">
                    ${statusHeader}<br>
                    <div style="margin-top:4px; border-top:1px solid rgba(255,255,255,0.2); padding-top:4px;">
                        <b>ID: ${item.id}</b><br>
                        Pos: ${item.pos} <span style="color:#ccc">(${tierName})</span><br>
                        KL: ${item.w} kg<br>
                        Nhóm: ${item.group}<br>
                        SO: ${displaySO}
                    </div>
                </div>
            </div>
        `;
    }

    // --- SEARCH (MÀU VÀNG) ---
    function handleSearch() {
        const kw = document.getElementById('searchInput').value.trim().toUpperCase();
        if(!kw) return;
        document.querySelectorAll('.highlight').forEach(e=>e.classList.remove('highlight'));
        
        let found = 0;
        document.querySelectorAll('.coil-box').forEach(c=>{
            if (c.classList.contains('empty')) return;
            const id = c.getAttribute('data-id') ? c.getAttribute('data-id').toUpperCase() : "";
            const so = c.getAttribute('data-so') ? c.getAttribute('data-so').toUpperCase() : "";

            if(id.includes(kw) || so.includes(kw)){
                c.classList.add('highlight'); // MÀU VÀNG
                c.scrollIntoView({behavior:"smooth", block:"center"}); 
                found++;
            }
        });

        if (found > 0) return;

        const inError = GLOBAL_INVALID_LIST.find(i => i.id.toUpperCase().includes(kw) || i.so.toUpperCase().includes(kw));
        if (inError) {
            alert(`⚠️ Cuộn này nằm trong danh sách LỖI! Đang mở...`);
            openListModal('error');
            return;
        }

        const inAuto = GLOBAL_AUTO_LIST.find(i => i.id.toUpperCase().includes(kw) || i.so.toUpperCase().includes(kw));
        if (inAuto) {
             alert(`ℹ️ Cuộn này nằm trong danh sách GỢI Ý (Màu cam)!`);
             return;
        }
        alert("Không tìm thấy!");
    }
    
    document.getElementById('searchInput').addEventListener("keypress", (e)=>{if(e.key==="Enter") handleSearch()});
    loadData();
</script>

</body>
</html>