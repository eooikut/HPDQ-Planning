{% extends 'base.html' %}
{% block title %}Chi Ti·∫øt L·ªánh S·∫£n Xu·∫•t{% endblock %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet">
<style>
    /* --- B·∫ÆT ƒê·∫¶U KH·ªêI CSS N√ÇNG C·∫§P GIAO DI·ªÜN --- */

    /* Container ch√≠nh cho b·∫£ng, t·∫°o hi·ªáu ·ª©ng card */
    #data-grid-container {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        overflow: hidden; /* ƒê·∫£m b·∫£o bo g√≥c ƒë∆∞·ª£c √°p d·ª•ng cho b·∫£ng b√™n trong */
        border: 1px solid #dee2e6;
    }
    .data-warning {
    background: #fff3cd !important; /* M√†u v√†ng nh·∫°t (m√†u warning c·ªßa Bootstrap) */
    color: #664d03 !important;
    }
    /* Font ch·ªØ v√† k√≠ch th∆∞·ªõc chung */
    .handsontable {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 14px;
    }

    /* Header c·ªßa b·∫£ng */
    .handsontable th {
        background-color: #e9f2ff; /* N·ªÅn xanh d∆∞∆°ng nh·∫°t */
        color: #0a58ca; /* Ch·ªØ m√†u xanh ƒë·∫≠m */
        font-weight: bold; /* TƒÉng ƒë·ªô ƒë·∫≠m c·ªßa ch·ªØ */
        text-align: center !important;
        padding: 12px 8px;
        border-bottom: 2px solid #dee2e6 !important;
        border-right: 1px solid #dee2e6 !important;
        transition: background-color 0.2s ease-in-out; /* Th√™m hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªïi */
    }
    .handsontable th:hover {
        background-color: #dbe8ff; /* M√†u n·ªÅn ƒë·∫≠m h∆°n m·ªôt ch√∫t khi di chu·ªôt v√†o */
    }

    /* M√†u n·ªÅn xen k·∫Ω cho c√°c d√≤ng */
    .handsontable .htCore tbody tr:nth-child(even) > td {
        background-color: #f9f9f9;
    }
    .handsontable .htCore tbody tr:nth-child(odd) > td {
        background-color: #ffffff;
    }

    /* Style cho c√°c √¥ d·ªØ li·ªáu */
    .handsontable td {
        padding: 8px;
        vertical-align: middle;
        border-right: 1px solid #e9ecef;
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.2s ease;
    }

    /* T√¥ s√°ng d√≤ng v√† c·ªôt ƒëang ƒë∆∞·ª£c ch·ªçn */
    .handsontable .ht__highlight {
        background-color: #e9f2ff !important;
    }

    /* Style cho √¥ ƒë√£ ƒë∆∞·ª£c ch·ªânh s·ª≠a (dirty) */
    .handsontable .htDirty {
        background-color: #fffbe6 !important; /* M√†u v√†ng nh·∫°t */
        border-left: 3px solid #ffc107; /* Th√™m vi·ªÅn tr√°i m√†u v√†ng */
    }

    /* Style cho √¥ ch·ªâ ƒë·ªçc (read-only) */
    .data-readonly { background: #f1f3f5 !important; color: #6c757d !important; font-style: italic; }

    /* --- B·∫ÆT ƒê·∫¶U KH·ªêI CSS CHO B·ªò L·ªåC V√Ä GIAO DI·ªÜN N√ÇNG CAO --- */

    /* Icon m≈©i t√™n cho menu l·ªçc */
    .handsontable .htDropdownMenu {
        color: #adb5bd; /* M√†u x√°m nh·∫°t */
        transition: color 0.2s ease-in-out;
    }
    .handsontable th:hover .htDropdownMenu {
        color: #0d6efd; /* M√†u xanh d∆∞∆°ng khi di chu·ªôt v√†o header */
    }

    /* Giao di·ªán c·ªßa menu l·ªçc */
    .htFiltersMenu {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border-radius: 6px;
        border: 1px solid #dee2e6;
        margin-top: 5px;
    }
    .htFiltersMenu .htFiltersMenuLabel {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
    }
    .htFiltersMenu .htUIButton {
        border-radius: 4px;
    }

    /* T√πy ch·ªânh thanh cu·ªôn (scrollbar) cho ƒë·∫πp h∆°n */
    .handsontable .wtHider::-webkit-scrollbar { width: 8px; height: 8px; }
    .handsontable .wtHider::-webkit-scrollbar-track { background: #f1f1f1; }
    .handsontable .wtHider::-webkit-scrollbar-thumb {
        background: #ced4da;
        border-radius: 4px;
    }
    .handsontable .wtHider::-webkit-scrollbar-thumb:hover { background: #adb5bd; }

    /* --- K·∫æT TH√öC KH·ªêI CSS N√ÇNG CAO --- */
    /* --- K·∫æT TH√öC KH·ªêI CSS N√ÇNG C·∫§P --- */
</style>

<h2>L·∫≠p l·ªánh s·∫£n xu·∫•t</h2>
<p id="page-description">
    B·∫£ng ƒëang ·ªü ch·∫ø ƒë·ªô "Ch·ªâ xem". Nh·∫•n "Ch·ªânh s·ª≠a" ƒë·ªÉ b·∫≠t/t·∫Øt ch·∫ø ƒë·ªô nh·∫≠p li·ªáu.
    Khi kh√¥ng c√≥ d·ªØ li·ªáu, b·∫°n c√≥ th·ªÉ nh·∫•n "Ch·ªânh s·ª≠a" ƒë·ªÉ b·∫Øt ƒë·∫ßu th√™m d√≤ng m·ªõi.
</p>

<div style="margin-top: 15px; margin-bottom: 20px;">
    <button id="edit-toggle-button" class="btn btn-primary">
        <i class="fas fa-edit"></i> Ch·ªânh s·ª≠a
    </button>
    <button id="save-button" class="btn btn-success" style="display: none; margin-left: 10px;">
        <i class="fas fa-save"></i> L∆∞u D·ªØ li·ªáu
    </button>
    <button id="sort-button" class="btn btn-outline-secondary" style="display: none; margin-left: 10px;">
        <i class="fas fa-sort-amount-down"></i> S·∫Øp x·∫øp D·ªØ li·ªáu
    </button>
    <!-- <button id="add-row-button" class="btn btn-outline-primary" style="display: none; margin-left: 10px;">
        <i class="fas fa-plus"></i> Th√™m D√≤ng M·ªõi
    </button> -->
    <button id="delete-all-button" class="btn btn-danger" style="display: none; margin-left: 10px;">
        <i class="fas fa-trash-alt"></i> X√≥a To√†n B·ªô
    </button>
    <button id="export-template-button" class="btn btn-info" style="margin-left: 10px;">
        <i class="fas fa-file-excel"></i> Xu·∫•t L·ªánh s·∫£n xu·∫•t
    </button>
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#importModal" style="margin-left: 10px;">
        <i class="fas fa-file-import"></i> Import Excel
    </button>
</div>

<div id="data-grid-container">
    <div id="data-grid"></div>
</div>

<!-- Modal Import Excel -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel"><i class="fas fa-file-import me-2"></i>Import ƒê∆°n H√†ng t·ª´ Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="importForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="donhang_input_file" class="form-label fw-bold">
                            <i class="fas fa-file-invoice me-2 text-primary"></i>Ch·ªçn file ƒê∆°n H√†ng (Input)
                        </label>
                        <input type="file" id="donhang_input_file" name="donhang_input_file" class="form-control" accept=".xlsx" required>
                        <div class="form-text">T·∫£i l√™n file <code>input.xlsx</code> (sheet 'ƒê∆†N H√ÄNG') ƒë·ªÉ x·ª≠ l√Ω.</div>
                    </div>
                    <div class="alert alert-warning mt-3" role="alert" style="font-size: 0.9rem;">
                        <i class="fas fa-exclamation-triangle me-2"></i><strong>L∆∞u √Ω quan tr·ªçng:</strong>
                        Thao t√°c n√†y s·∫Ω <strong>x√≥a to√†n b·ªô d·ªØ li·ªáu hi·ªán c√≥</strong> v√† thay th·∫ø b·∫±ng d·ªØ li·ªáu t·ª´ file Excel.
                    </div>
                    <div id="import-status" class="mt-3"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="submit" form="importForm" id="import-submit-button" class="btn btn-primary">
                    <i class="fas fa-upload me-2"></i>B·∫Øt ƒë·∫ßu Import
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let hot; 
    let isEditMode = false;
    let originalData = []; // Bi·∫øn l∆∞u data g·ªëc ƒë·ªÉ "H·ªßy"

    // L·∫•y c√°c DOM element
    const container = document.getElementById('data-grid');
    const editToggleButton = document.getElementById('edit-toggle-button');
    const saveButton = document.getElementById('save-button');
    const sortButton = document.getElementById('sort-button');
    // const addRowButton = document.getElementById('add-row-button');
    const deleteAllButton = document.getElementById('delete-all-button');
    const exportTemplateButton = document.getElementById('export-template-button');
    let isRecalculating = false; // C·ªù ƒë·ªÉ tr√°nh v√≤ng l·∫∑p v√¥ t·∫≠n

    // --- H√ÄM TI·ªÜN √çCH: C·∫¨P NH·∫¨T S·ªê TH·ª® T·ª∞ ---
    function updateRowNumbers() {
        if (!hot) return;
        const rowCount = hot.countRows();
        const changes = [];
        for (let i = 0; i < rowCount; i++) {
            // C·ªôt 'STT' l√† c·ªôt th·ª© 2 (ch·ªâ s·ªë 1)
            // Gi√° tr·ªã m·ªõi l√† v·ªã tr√≠ d√≤ng (i) + 1
            changes.push([i, 1, i + 1]);
        }
        // S·ª≠ d·ª•ng setDataAtCell ƒë·ªÉ c·∫≠p nh·∫≠t nhi·ªÅu √¥ c√πng l√∫c m√† kh√¥ng trigger hook li√™n t·ª•c
        // Tham s·ªë 'source' l√† 'updateRowNumbers' ƒë·ªÉ tr√°nh v√≤ng l·∫∑p v√¥ t·∫≠n n·∫øu c·∫ßn
        hot.setDataAtCell(changes, null, null, 'updateRowNumbers');
    }

    // --- H√ÄM TI·ªÜN √çCH: T√çNH TO√ÅN L·∫†I DUNG SAI & SL Y√äU C·∫¶U ---
    // T√°i t·∫°o logic t·ª´ XuLyDuLieuNhapVao.py ƒë·ªÉ t√≠nh to√°n real-time
    function parseKL_Cuon(klCuonStr) {
        if (!klCuonStr || typeof klCuonStr !== 'string') return NaN;

        const s_value = klCuonStr.trim();
        // T√¨m d·∫£i s·ªë "min-max"
        const rangeMatch = s_value.match(/(\d+)\s*-\s*(\d+)/);
        if (rangeMatch) {
            const num1 = parseInt(rangeMatch[1], 10);
            const num2 = parseInt(rangeMatch[2], 10);
            const cw_max = Math.max(num1, num2);
            return cw_max - 0.5;
        }

        // N·∫øu kh√¥ng c√≥ d·∫£i, t√¨m s·ªë ƒë∆°n l·∫ª ƒë·∫ßu ti√™n
        const singleNumMatch = s_value.match(/\d+/);
        if (singleNumMatch) {
            const num = parseInt(singleNumMatch[0], 10);
            return num - 0.5;
        }

        return NaN;
    }

    function recalculateRow(rowIndex) {
        if (isRecalculating) return; // NgƒÉn v√≤ng l·∫∑p

        const rowData = hot.getSourceDataAtRow(rowIndex);
        
        const sanLuong1A = parseFloat(rowData.SanLuong_1A) || 0;
        const sanLuong1B = parseFloat(rowData.SanLuong_1B) || 0;
        const klCuonStr = rowData.KL_Cuon;

        const tong_san_luong = sanLuong1A + sanLuong1B;
        const avg_kl_cuon = parseKL_Cuon(klCuonStr);

        let sanLuongYeuCauCuon = 0;
        let dungSaiStr = "¬± 0";

        if (!isNaN(avg_kl_cuon) && avg_kl_cuon > 0) {
            const sanLuongYeucauFloat = tong_san_luong / avg_kl_cuon;
            sanLuongYeuCauCuon = Math.round(sanLuongYeucauFloat);

            const base_dung_sai_float = 0.1 * sanLuongYeucauFloat;
            let adjusted_dung_sai_float = (tong_san_luong > 2000) ? (base_dung_sai_float / 2) : base_dung_sai_float;
            
            const dung_sai_int = Math.round(adjusted_dung_sai_float);
            dungSaiStr = `¬± ${dung_sai_int}`;
        }

        // C·∫≠p nh·∫≠t d·ªØ li·ªáu v√†o b·∫£ng
        isRecalculating = true;
        hot.setDataAtRowProp([
            [rowIndex, 'SanLuong_YeuCau_Cuon', sanLuongYeuCauCuon],
            [rowIndex, 'DungSai', dungSaiStr]
        ], 'recalculate');
        
        setTimeout(() => { isRecalculating = false; }, 0);
    }

    // 4. C·∫§U H√åNH HANDSONTABLE (R·∫§T QUAN TR·ªåNG)
    function initializeHandsontable(data) {
        hot = new Handsontable(container, {
            data: data,
            
            // Ti√™u ƒë·ªÅ c·ªôt (ph·∫£i kh·ªõp v·ªõi file Excel)
            colHeaders: [
                'ID', 'TT', 'Th·ªùi gian SX', 'K√≠ch c·ª°', 'M√°c th√©p', 'S.L∆∞·ª£ng 1A', 'S.L∆∞·ª£ng 1B', 
                'SL Y/C (cu·ªôn)', 'Dung sai', 'GHC (Re)', 'GHB (Rm)', 'Gi√£n d√†i (El)', 'ƒê·ªô c·ª©ng',
                'M√°c ph√¥i', 'K√≠ch th∆∞·ªõc ph√¥i', 'Y√™u c·∫ßu ƒë·∫∑c bi·ªát', 'S·ªë Order', 'S·ªë l√¥ (Batch)',
                'KL Cu·ªôn', 'M·ª•c ƒë√≠ch', 'Kh√°ch h√†ng'
            ],
            
            // √Ånh x·∫° data (ph·∫£i kh·ªõp v·ªõi t√™n c·ªôt SQL/JSON t·ª´ API)
            columns: [
                { data: 'ID', readOnly: true }, // C·ªôt 0
                { data: 'STT', type: 'numeric' }, // C·ªôt 1 - B·ªè readOnly ƒë·ªÉ c·∫≠p nh·∫≠t sau khi sort
                { data: 'ThoiGianSX', type: 'text' },
                { data: 'KichCo', type: 'text' },
                { data: 'MacThep', type: 'text' },
                { data: 'SanLuong_1A', type: 'numeric', numericFormat: { pattern: '0,0' } },
                { data: 'SanLuong_1B', type: 'numeric', numericFormat: { pattern: '0,0' } },
                { data: 'SanLuong_YeuCau_Cuon', type: 'numeric', numericFormat: { pattern: '0,0' }, readOnly: true }, // V·∫´n kh√≥a, nh∆∞ng gi√° tr·ªã s·∫Ω ƒë∆∞·ª£c JS c·∫≠p nh·∫≠t
                { data: 'DungSai', type: 'text', readOnly: true }, // V·∫´n kh√≥a, nh∆∞ng gi√° tr·ªã s·∫Ω ƒë∆∞·ª£c JS c·∫≠p nh·∫≠t
                { data: 'CoTinh_GHC', type: 'text' },
                { data: 'CoTinh_GHB', type: 'text' },
                { data: 'CoTinh_GianDai', type: 'text' },
                { data: 'CoTinh_DoCung', type: 'text' },
                { data: 'Phoi_MacPhoi', type: 'text' },
                { data: 'Phoi_KichThuoc', type: 'text' },
                { data: 'YeuCauDacBiet', type: 'text' },
                { data: 'OrderNumber', type: 'numeric' },
                { data: 'Batch', type: 'numeric' },
                { data: 'KL_Cuon', type: 'text' },
                { data: 'MucDichSuDung', type: 'text' },
                { data: 'KhachHang', type: 'text' },
                { data: 'DotSX', type: 'text' } ,
                { data: 'HasWarning'}// Th√™m c·ªôt DotSX ƒë·ªÉ d√πng khi export
            ],
            
            // C·∫•u h√¨nh ·∫©n c·ªôt ID (v·∫´n l·∫•y data nh∆∞ng kh√¥ng hi·ªÉn th·ªã)
            hiddenColumns: {
                columns: [0, 21 , 22], // ·∫®n c·ªôt 0 (ID) v√† c·ªôt 21 (DotSX)
                indicators: false
            },

            // Logic kh√≥a/m·ªü √¥
            cells: function (row, col, prop) {
                const cellProperties = {};
                // D√πng "this.instance" thay v√¨ "hot"
                const rowData = this.instance.getSourceDataAtRow(row); 

                // 1. ∆Øu ti√™n cao nh·∫•t: T√¥ m√†u c·∫£nh b√°o
                if (rowData && rowData.HasWarning) {
                    cellProperties.className = 'data-warning';
                }

                // 2. X√©t ReadOnly (Th√™m 'HasWarning' v√†o ƒë√¢y)
                if (prop === 'ID' || prop === 'SanLuong_YeuCau_Cuon' || prop === 'DungSai' || prop === 'STT' || prop === 'HasWarning') {
                    cellProperties.readOnly = true;
                } else {
                    cellProperties.readOnly = !isEditMode;
                }
                
                // 3. T√¥ m√†u ReadOnly (CH·ªà KHI n√≥ ch∆∞a ƒë∆∞·ª£c t√¥ m√†u warning)
                if (cellProperties.readOnly && !cellProperties.className) {
                    // Ch·ªâ th√™m class 'data-readonly' n·∫øu n√≥ ch∆∞a c√≥ class 'data-warning'
                    cellProperties.className = 'data-readonly';
                }
                
                return cellProperties;
            },
            
            // C√°c c√†i ƒë·∫∑t kh√°c
            rowHeaders: false,
            // selectionMode: 'row',        // ƒê·ªïi ch·∫ø ƒë·ªô ch·ªçn t·ª´ 'cell' (m·∫∑c ƒë·ªãnh) sang 'row'
            // currentRowClassName: 'ht-current-row',
            // --- GI·∫¢I PH√ÅP: T·∫Øt ho√†n to√†n s·∫Øp x·∫øp ph√≠a client ---
            // Vi·ªác s·∫Øp x·∫øp ƒë√£ ƒë∆∞·ª£c th·ª±c hi·ªán ·ªü server. T·∫Øt t√≠nh nƒÉng n√†y
            // ƒë·ªÉ ƒë·∫£m b·∫£o th·ª© t·ª± d·ªØ li·ªáu lu√¥n ƒë√∫ng v√† kh√¥ng b·ªã ng∆∞·ªùi d√πng thay ƒë·ªïi.
            columnSorting: false,
            filters: true,
            dropdownMenu: true, // B·∫≠t l·∫°i icon menu l·ªçc tr√™n header
            // B·∫≠t menu chu·ªôt ph·∫£i (ch·ªâ ho·∫°t ƒë·ªông khi isEditMode = true)
            contextMenu: {
                items: {
                    "row_above": { name: 'Ch√®n d√≤ng ph√≠a tr√™n' },
                    "row_below": { name: 'Ch√®n d√≤ng ph√≠a d∆∞·ªõi' },
                    "remove_row": { name: 'X√≥a d√≤ng ƒë√£ ch·ªçn' },
                    "---------": {},
                    "undo": { name: 'Ho√†n t√°c' },
                    "redo": { name: 'L√†m l·∫°i' }
                }
            },
            width: '100%',
            height: 'auto',
            colWidths: [0.1, 40, 100, 100, 100, 80, 80, 80, 60, 80, 80, 80, 80, 100, 100, 150, 100, 100, 80, 120, 120, 0.1,0.1], // C·ªôt 0 (ID) v√† 21 (DotSX) si√™u nh·ªè
            licenseKey: 'non-commercial-and-evaluation',
            // V√¥ hi·ªáu h√≥a context menu khi kh√¥ng ·ªü ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
            beforeContextMenuShow: function(e) { if (!isEditMode) { e.stopImmediatePropagation(); } }
            ,
            // --- HOOKS: T·ª∞ ƒê·ªòNG C·∫¨P NH·∫¨T S·ªê TH·ª® T·ª∞ ---
            afterCreateRow: function(index, amount) {
                updateRowNumbers();
                // T√≠nh to√°n cho d√≤ng m·ªõi ƒë∆∞·ª£c t·∫°o
                for (let i = 0; i < amount; i++) {
                    recalculateRow(index + i);
                }
            },
            afterRemoveRow: function(index, amount) {
                updateRowNumbers();
            },
            // --- HOOKS: T·ª∞ ƒê·ªòNG T√çNH TO√ÅN L·∫†I D·ªÆ LI·ªÜU KHI CH·ªàNH S·ª¨A ---
            afterChange: function(changes, source) {
                if (['edit', 'paste'].includes(source) && !isRecalculating) {
                    const affectedRows = new Set(changes.map(change => change[0]));
                    affectedRows.forEach(rowIndex => recalculateRow(rowIndex));
                }
            }
        });
    }

    // 5. LOGIC T·∫¢I TRANG: T·∫£i d·ªØ li·ªáu t·ª´ server
    document.addEventListener('DOMContentLoaded', () => {
        fetch('/api/get-lsx-data')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                // L∆∞u tr·∫°ng th√°i g·ªëc (c√≥ th·ªÉ l√† m·∫£ng r·ªóng ho·∫∑c m·∫£ng c√≥ d·ªØ li·ªáu)
                originalData = JSON.parse(JSON.stringify(data)); 
                initializeHandsontable(data); // Kh·ªüi t·∫°o b·∫£ng v·ªõi d·ªØ li·ªáu g·ªëc
                setupButtons(); 
            })
            .catch(error => {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
                container.innerHTML = `<div class='alert alert-danger'>Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ server. ${error.message}</div>`;
            });
    });

    // 6. LOGIC C√ÅC N√öT B·∫§M (G√°n sau khi 'hot' ƒë√£ ƒë∆∞·ª£c t·∫°o)
    function setupButtons() {
        if (!hot) return;

        // N√∫t Ch·ªânh s·ª≠a / H·ªßy
        editToggleButton.addEventListener('click', () => {
            isEditMode = !isEditMode; 
            if (isEditMode) {
                editToggleButton.innerHTML = '<i class="fas fa-times"></i> Tr·ªü v·ªÅ';
                editToggleButton.classList.replace('btn-primary', 'btn-warning');
                saveButton.style.display = 'inline-block';
                sortButton.style.display = 'inline-block';
                // addRowButton.style.display = 'inline-block';
                deleteAllButton.style.display = 'inline-block';
                exportTemplateButton.style.display = 'none'; // ·∫®n n√∫t xu·∫•t
            } else {
                editToggleButton.innerHTML = '<i class="fas fa-edit"></i> Ch·ªânh s·ª≠a';
                editToggleButton.classList.replace('btn-warning', 'btn-primary');
                saveButton.style.display = 'none';
                sortButton.style.display = 'none';
                // addRowButton.style.display = 'none';
                deleteAllButton.style.display = 'none';
                exportTemplateButton.style.display = 'inline-block'; // Hi·ªán l·∫°i n√∫t xu·∫•t
                hot.loadData(originalData); // T·∫£i l·∫°i data g·ªëc khi H·ªßy
            }
            hot.render();
        });

        // N√∫t L∆∞u
        saveButton.addEventListener('click', () => {
            const dataToSave = hot.getSourceData();
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang l∆∞u...';
            saveButton.disabled = true;
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            fetch('/api/save-lsx-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json','X-CSRFToken': csrfToken },
                body: JSON.stringify(dataToSave)
            })
            .then(res => res.json())
            .then(result => {
                alert(result.message);
                if (result.status === 'success') {
                    // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang danh s√°ch sau khi l∆∞u th√†nh c√¥ng
                    window.location.href = "{{ url_for('lsx.lap_lsx') }}";
                }
            })
            .catch(err => alert('L·ªói: ' + err.message))
            .finally(() => {
                saveButton.innerHTML = '<i class="fas fa-save"></i> L∆∞u D·ªØ li·ªáu';
                saveButton.disabled = false;
            });
        });
        
        // --- H√ÄM XU·∫§T FILE EXCEL (T√ÅCH RI√äNG ƒê·ªÇ T√ÅI S·ª¨ D·ª§NG) ---
        function exportData(dataToExport, buttonElement) {
            const originalButtonHTML = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
            buttonElement.disabled = true;
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            fetch('/api/export-with-template', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json','X-CSRFToken': csrfToken },
                body: JSON.stringify(dataToExport)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.message || 'L·ªói server') });
                }
                // L·∫•y t√™n file t·ª´ header Content-Disposition n·∫øu c√≥, n·∫øu kh√¥ng th√¨ d√πng t√™n m·∫∑c ƒë·ªãnh
                const disposition = response.headers.get('Content-Disposition');
                let filename = "LSX_Export.xlsx";
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                return response.blob().then(blob => ({ blob, filename }));
            })
            .then(({ blob, filename }) => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none'; a.href = url; a.download = filename;
                document.body.appendChild(a); a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            })
            .catch(err => alert('L·ªói khi xu·∫•t file: ' + err.message))
            .finally(() => {
                buttonElement.innerHTML = originalButtonHTML;
                buttonElement.disabled = false;
            });
        }

        // N√∫t Xu·∫•t Template (kh√¥ng s·∫Øp x·∫øp)
        exportTemplateButton.addEventListener('click', () => {
            const dataToExport = hot.getSourceData(); // L·∫•y data d·∫°ng object ƒë·ªÉ c√≥ key 'DotSX'
            exportData(dataToExport, exportTemplateButton);
        });

        // --- LOGIC N√öT M·ªöI: S·∫ÆP X·∫æP D·ªÆ LI·ªÜU TR√äN B·∫¢NG ---
        sortButton.addEventListener('click', () => {
            const dataToSort = hot.getSourceData();

            // H√†m helper ƒë·ªÉ parse c·ªôt 'KichCo' (v√≠ d·ª•: '2.3x1230X')
            function parseKichCo(kichCoStr) {
                if (typeof kichCoStr !== 'string' || !kichCoStr) return { doDay: 0, khoRong: 0 };
                const parts = kichCoStr.toLowerCase().split('x');
                const doDay = parseFloat(parts[0]) || 0;
                let khoRong = 0;
                if (parts.length > 1) {
                    const khoRongMatch = parts[1].match(/\d+/);
                    khoRong = khoRongMatch ? parseInt(khoRongMatch[0], 10) : 0;
                }
                return { doDay, khoRong };
            }

            // S·∫Øp x·∫øp d·ªØ li·ªáu
            dataToSort.sort((a, b) => {
                const a_parsed = parseKichCo(a.KichCo);
                const b_parsed = parseKichCo(b.KichCo);
                if (b_parsed.khoRong !== a_parsed.khoRong) return b_parsed.khoRong - a_parsed.khoRong;
                return b_parsed.doDay - a_parsed.doDay;
            });

            // C·∫≠p nh·∫≠t l·∫°i b·∫£ng v·ªõi d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c s·∫Øp x·∫øp
            hot.loadData(dataToSort); // T·∫£i l·∫°i d·ªØ li·ªáu s·∫Ω t·ª± ƒë·ªông render
            updateRowNumbers(); // G·ªçi h√†m ƒë·ªÉ ƒë√°nh l·∫°i s·ªë th·ª© t·ª±
            alert('ƒê√£ s·∫Øp x·∫øp d·ªØ li·ªáu. Nh·∫•n "L∆∞u" ƒë·ªÉ ghi l·∫°i thay ƒë·ªïi.');
        });

        // --- LOGIC N√öT X√ìA TO√ÄN B·ªò ---
        deleteAllButton.addEventListener('click', () => {
        if (confirm('B·∫†N C√ì CH·∫ÆC CH·∫ÆN MU·ªêN X√ìA TO√ÄN B·ªò D·ªÆ LI·ªÜU KH√îNG?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
            deleteAllButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x√≥a...';
            deleteAllButton.disabled = true;

            // üöÄ TH√äM D√íNG N√ÄY: L·∫•y token ngay tr∆∞·ªõc khi g·ªçi fetch
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            fetch('/api/clear-lsx-data', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken // Gi·ªù bi·∫øn n√†y ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a
                },
            })
            .then(res => {
                // Th√™m b∆∞·ªõc ki·ªÉm tra response.ok
                if (!res.ok) {
                    return res.json().then(err => { throw new Error(err.message || `L·ªói ${res.status}`) });
                }
                return res.json();
            })
            .then(result => {
                alert(result.message);
                if (result.status === 'success') {
                    hot.loadData([]); // X√≥a d·ªØ li·ªáu tr√™n b·∫£ng
                    originalData = []; // X√≥a d·ªØ li·ªáu g·ªëc
                }
            })
            .catch(err => alert('L·ªói khi x√≥a: ' + err.message)) // S·∫Ω b·∫Øt ƒë∆∞·ª£c l·ªói (k·ªÉ c·∫£ l·ªói 400)
            .finally(() => {
                deleteAllButton.innerHTML = '<i class="fas fa-trash-alt"></i> X√≥a To√†n B·ªô';
                deleteAllButton.disabled = false;
            });
        }
    });

        // --- LOGIC CHO MODAL IMPORT EXCEL ---
        const importForm = document.getElementById('importForm');
        const importSubmitButton = document.getElementById('import-submit-button');
        const importModal = new bootstrap.Modal(document.getElementById('importModal'));
        const importStatus = document.getElementById('import-status');
        let tempFilenameForImport = null; // Bi·∫øn l∆∞u t√™n file t·∫°m

        // 1. X·ª≠ l√Ω khi nh·∫•n n√∫t "B·∫Øt ƒë·∫ßu Import"
        importForm.addEventListener('submit', function(event) {
            event.preventDefault(); // NgƒÉn form submit theo c√°ch truy·ªÅn th·ªëng

            const formData = new FormData(this);
            const fileInput = document.getElementById('donhang_input_file');

            if (!fileInput.files || fileInput.files.length === 0) {
                alert("Vui l√≤ng ch·ªçn m·ªôt file.");
                return;
            }

            importSubmitButton.disabled = true;
            importSubmitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i l√™n...';
            importStatus.innerHTML = `<div class="alert alert-info">ƒêang x·ª≠ l√Ω file, vui l√≤ng ch·ªù...</div>`;
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            // G·ª≠i file tr·ª±c ti·∫øp ƒë·ªÉ import (kh√¥ng qua b∆∞·ªõc preview n·ªØa)
            fetch('/api/import-don-hang', {
                method: 'POST',
                headers: {
                'X-CSRFToken': csrfToken 
            },
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    importModal.hide(); // ƒê√≥ng modal
                    window.location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ th·∫•y d·ªØ li·ªáu m·ªõi
                } else {
                    // N·∫øu c√≥ l·ªói t·ª´ server, hi·ªÉn th·ªã n√≥
                    throw new Error(result.message || 'C√≥ l·ªói x·∫£y ra t·ª´ server.');
                }
            })
            .catch(error => {
                importStatus.innerHTML = `<div class="alert alert-danger">L·ªói: ${error.message}</div>`;
            })
            .finally(() => { // Lu√¥n reset n√∫t b·∫•m
                importSubmitButton.disabled = false;
                importSubmitButton.innerHTML = '<i class="fas fa-upload me-2"></i>B·∫Øt ƒë·∫ßu Import';
            });
        });

        // ƒê√£ lo·∫°i b·ªè h√†m displayPreview v√† logic li√™n quan ƒë·∫øn n√∫t "X√°c nh·∫≠n"
    }

</script>

{% endblock %}
