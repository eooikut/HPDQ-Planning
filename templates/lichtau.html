{% extends "base.html" %}
{% block title %}L·ªãch t√†u{% endblock %}
{% block content %}
<div class="page-wrapper">
<h3 style="margin-bottom: 20px">L·ªãch t√†u</h3>

<form id="searchForm" class="d-flex mb-3" style="max-width: 600px">
  <input
    type="text"
    class="form-control me-2"
    id="keyword"
    name="keyword"
    placeholder="T√¨m Material, Sales Order..."
    value="{{ keyword }}"
  />
</form>

<div class="d-flex mb-3 gap-2" style="max-width: 1600px;">
  <select id="filter-sheetmonth" class="form-select">
    <option value="">-- Ch·ªçn Th√°ng --</option>
    {% for month in sheetmonth_list %}
    <option value="{{ month }}" {% if month==selected_month %}selected{% endif %}>{{ month }}</option>
    {% endfor %}
  </select>
  <select id="filter-tau" class="form-select">
    <option value="">T·∫•t c·∫£ T√†u</option>
    {% for tau in tau_list %}
    <option value="{{ tau }}">{{ tau }}</option>
    {% endfor %}
  </select>
  <select id="filter-cangxep" class="form-select">
    <option value="">T·∫•t c·∫£ C·∫£ng X·∫øp</option>
    {% for cangxep in cangxep_list %}
    <option value="{{ cangxep }}">{{ cangxep }}</option>
    {% endfor %}
  </select>
  <select id="filter-cangden" class="form-select">
    <option value="">T·∫•t c·∫£ C·∫£ng ƒê·∫øn</option>
    {% for cangden in cangden_list %}
    <option value="{{ cangden }}">{{ cangden }}</option>
    {% endfor %}
  </select>
  <select id="filter-daily" class="form-select">
    <option value="">T·∫•t c·∫£ ƒê·∫°i l√Ω</option>
    {% for daily in daily_list %}
    <option value="{{ daily }}">{{ daily }}</option>
    {% endfor %}
  </select>
    <select id="filter-nhamay" class="form-select">
    <option value="">T·∫•t c·∫£ Nh√† m√°y</option>
    {% for nm in nhamay_list %}
    <option value="{{ nm }}">{{ nm }}</option>
    {% endfor %}
  </select>
  <select id="filter-tau-color" class="form-select">
    <option value="">-- T·∫•t c·∫£ tr·∫°ng th√°i t√†u --</option>
    {% for color in tau_color_list %}
    <option value="{{ color }}">
      {% if color == 'bg-success' %}Ho√†n th√†nh{% elif color == 'bg-warning' %}Ch∆∞a ho√†n th√†nh{% else %}{{ color }}{% endif %}
    </option>
    {% endfor %}
  </select>
  <button type="button" id="btn-reset" class="btn btn-secondary">Reset</button>
</div>

<div style="overflow-y: auto; overflow-x: auto;flex-grow: 1;">
  <table class="table-custom" id="lichtau-table">
    <thead>
      <tr>
        <th>T√†u</th>
        <th>ƒê·∫°i l√Ω</th>
        <th>C·∫£ng x·∫øp</th>
        <th>C·∫£ng ƒë·∫øn</th>
        <th>Sales Order</th>
        <th>Nh√† m√°y</th>
        <th>ƒê·ªãnh l∆∞·ª£ng</th>
        <th>Material</th>
        <th>S·∫£n l∆∞·ª£ng mapping Kho</th>
        <th>Shipped (t·∫•n)</th>
        <th>Quantity (t·∫•n)</th>
        <th>D·ª± ƒëo√°n ho√†n th√†nh</th>
        <th>Ti·∫øn ƒë·ªô</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
</div>
<style>
	.page-wrapper {
  display: flex;
  flex-direction: column;
  /* Gi·∫£ s·ª≠ <body> ho·∫∑c container cha c·ªßa block n√†y cao 100% m√†n h√¨nh.
     N·∫øu kh√¥ng, b·∫°n c√≥ th·ªÉ c·∫ßn d√πng: height: 90vh; (ho·∫∑c 100vh)
     tu·ª≥ thu·ªôc v√†o layout `base.html` c·ªßa b·∫°n */
  height: calc(100vh - 100px); /* V√≠ d·ª•: 100% chi·ªÅu cao tr·ª´ ƒëi 100px c·ªßa header/footer */
  /* Ho·∫∑c ƒë∆°n gi·∫£n l√†: */
  /* height: 100%;  */
}
  .table-custom { width: 100%; border-collapse: collapse; font-size: 14px; }
  .table-custom th, .table-custom td { border: 1px solid #ccc; padding: 10px; text-align: center; }
  .table-custom thead th { position: sticky; top: 0; background: #212529; color: #fff; z-index: 700; }
  .progress { height: 22px; border-radius: 12px; overflow: hidden; background: #e9ecef; }
  .progress-bar { line-height: 22px; color: #fff; font-weight: bold; border-radius: 12px; text-align: center; }
  .bg-success { background: #28a745 !important; }
  .bg-warning { background: #ffc107 !important; color: #212529; }
  .bg-danger { background: #dc3545 !important; }
  .text-right { text-align: right; }

  /* --- CSS for Sticky Columns --- */
  :root {
    --thead-height: 75px; /* Chi·ªÅu cao c·ªßa thead */
    --col1-width: 150px; /* T√†u */
    --col2-width: 200px; /* ƒê·∫°i l√Ω */
    --col3-width: 150px; /* C·∫£ng x·∫øp */
    --col4-width: 150px; /* C·∫£ng ƒë·∫øn */
  }

  /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông cho c√°c c·ªôt sticky */
  .table-custom th:nth-child(1), .table-custom td.sticky-col1 { width: var(--col1-width); min-width: var(--col1-width); max-width: var(--col1-width); }
  .table-custom th:nth-child(2), .table-custom td.sticky-col2 { width: var(--col2-width); min-width: var(--col2-width); max-width: var(--col2-width); }
  .table-custom th:nth-child(3), .table-custom td.sticky-col3 { width: var(--col3-width); min-width: var(--col3-width); max-width: var(--col3-width); }
  .table-custom th:nth-child(4), .table-custom td.sticky-col4 { width: var(--col4-width); min-width: var(--col4-width); max-width: var(--col4-width); }

  /* Sticky cho header */
  .table-custom thead th:nth-child(1) { position: sticky; left: 0; z-index: 650; }
  .table-custom thead th:nth-child(2) { position: sticky; left: var(--col1-width); z-index: 650; }
  .table-custom thead th:nth-child(3) { position: sticky; left: calc(var(--col1-width) + var(--col2-width)); z-index: 650; }
  .table-custom thead th:nth-child(4) { position: sticky; left: calc(var(--col1-width) + var(--col2-width) + var(--col3-width)); z-index: 650; }

  /* TD cho c√°c c·ªôt sticky ph·∫£i l√† static ƒë·ªÉ rowspan ho·∫°t ƒë·ªông ƒë√∫ng */
  .table-custom td.sticky-col {
    position: static;
    vertical-align: top;
    padding: 0;
    background: inherit; /* ƒÇn theo m√†u c·ªßa TR */
  }

  /* Wrapper b√™n trong TD ƒë·ªÉ th·ª±c hi·ªán sticky */
  .sticky-content {
    position: sticky;
    top: var(--thead-height); /* D√≠nh ngay d∆∞·ªõi header */
    display: block;
    width: 100%;
    padding: 10px; /* Gi·ªØ l·∫°i padding g·ªëc */
    box-sizing: border-box;
    z-index: 600;
    background: inherit !important; /* Lu√¥n ƒÉn theo m√†u c·ªßa TR */
    text-align: center;
  }

  /* Offset cho t·ª´ng c·ªôt */
  .sticky-content.sticky-col1 { left: 0; }
  .sticky-content.sticky-col2 { left: var(--col1-width); }
  .sticky-content.sticky-col3 { left: calc(var(--col1-width) + var(--col2-width)); }
  .sticky-content.sticky-col4 { left: calc(var(--col1-width) + var(--col2-width) + var(--col3-width)); }

  /* ƒê∆∞·ªùng k·∫ª ph√¢n c√°ch */
  .table-custom th:nth-child(-n+4), .table-custom td.sticky-col { box-shadow: 1px 0 0 #ddd; }

  /* B√¥i ƒë·∫≠m v√† tƒÉng c·ª° ch·ªØ cho c√°c c·ªôt T√†u, ƒê·∫°i l√Ω, C·∫£ng x·∫øp, C·∫£ng ƒë·∫øn */
  .table-custom td.sticky-col1 .sticky-content,
  .table-custom td.sticky-col2 .sticky-content,
  .table-custom td.sticky-col3 .sticky-content,
  .table-custom td.sticky-col4 .sticky-content {
    font-weight: bold;
    font-size: 16px; /* TƒÉng c·ª° ch·ªØ t·ª´ 14px l√™n 16px */
  }
</style>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
const tbody = document.querySelector("#lichtau-table tbody");
const keywordInput = document.getElementById("keyword");
const filterSheetMonth = document.getElementById("filter-sheetmonth");
const filterTau = document.getElementById("filter-tau");
const filterCangxep = document.getElementById("filter-cangxep");
const filterCangden = document.getElementById("filter-cangden");
const filterDaily = document.getElementById("filter-daily");
const filterTauColor = document.getElementById("filter-tau-color");
const btnReset = document.getElementById("btn-reset");
const filterNhamay = document.getElementById("filter-nhamay");

let allRows = []; // to√†n b·ªô d·ªØ li·ªáu
let groupedData = []; // nh√≥m theo t√†u
let currentPage = 1;
const rowsPerPage = 10;

// ‚úÖ Th√™m ph·∫ßn hi·ªÉn th·ªã ph√¢n trang ·ªü d∆∞·ªõi b·∫£ng (t·ª± t·∫°o)
// const paginationDiv = document.createElement("div");
// paginationDiv.id = "pagination";
// paginationDiv.className = "d-flex justify-content-center align-items-center gap-2 mt-3";
// document.querySelector("#lichtau-table").parentNode.appendChild(paginationDiv);
let paginationDiv = document.createElement("div");
paginationDiv.id = "pagination";
paginationDiv.className = "d-flex justify-content-center align-items-center gap-2 mt-3";
document.querySelector("#lichtau-table").after(paginationDiv);

// ========== L·∫•y filter ==========
function getFilters() {
  const params = new URLSearchParams(window.location.search);
  return {
    keyword: keywordInput.value.trim(),
    sheetmonth: filterSheetMonth.value,
    tau: filterTau.value,
    cangxep: filterCangxep.value,
    cangden: filterCangden.value,
    daily: filterDaily.value,
    nhamay: filterNhamay.value,
    tau_color: filterTauColor.value,
  };
}
function updateURL() {
  const filters = getFilters();
  const params = new URLSearchParams(filters);
  window.history.replaceState({}, "", `${window.location.pathname}?${params.toString()}`);
}
function restoreFiltersFromURL() {
  const params = new URLSearchParams(window.location.search);
  keywordInput.value = params.get("keyword") || "";
  filterSheetMonth.value = params.get("sheetmonth") || "";
  filterTau.value = params.get("tau") || "";
  filterCangxep.value = params.get("cangxep") || "";
  filterCangden.value = params.get("cangden") || "";
  filterDaily.value = params.get("daily") || "";
  filterNhamay.value = params.get("nhamay") || "";
  filterTauColor.value = params.get("tau_color") || "";
}
async function fetchRows(updateDropdowns = true) {
  updateURL();
  const params = new URLSearchParams(getFilters());
  tbody.innerHTML = `
    <tr>
      <td colspan="10" class="text-center py-3 text-muted">
        <div class="spinner-border spinner-border-sm me-2"></div>ƒêang t·∫£i d·ªØ li·ªáu...
      </td>
    </tr>
  `;

  try {
    const res = await fetch(`/lichtau_search?${params.toString()}`);
    const data = await res.json();
    allRows = data.rows || [];

    // üß† Ki·ªÉm so√°t dropdown c·∫≠p nh·∫≠t
    if (updateDropdowns === true) {
      updateDropdownsFromData(data.rows);              // load l·∫ßn ƒë·∫ßu
    } else if (updateDropdowns === "tau") {
      updateTauDropdown(data.rows);                    // khi ch·ªçn dropdown kh√°c
    } else if (updateDropdowns === "related") {
      updateRelatedDropdowns(data.rows);               // khi ch·ªçn t√†u
    }

    prepareGroups();
    renderPage(1);
  } catch (err) {
    tbody.innerHTML = `
      <tr>
        <td colspan="10" class="text-danger text-center py-2">L·ªói t·∫£i d·ªØ li·ªáu</td>
      </tr>
    `;
    console.error(err);
  }
}

// ========== C·∫≠p nh·∫≠t dropdown ==========
function updateDropdownsFromData(records) {
  const tauSet = new Set(records.map(r => r.tau).filter(Boolean));
  const cangxepSet = new Set(records.map(r => r.cangxep).filter(Boolean));
  const cangdenSet = new Set(records.map(r => r.cangden).filter(Boolean));
  const dailySet = new Set(records.map(r => r.daily).filter(Boolean));
  const nhamaySet = new Set(records.map(r => r.nhamay).filter(Boolean));
  const tauColorSet = new Set(records.map(r => r.tau_status_color).filter(Boolean));

  updateDropdown(filterTau, tauSet);
  updateDropdown(filterCangxep, cangxepSet);
  updateDropdown(filterCangden, cangdenSet);
  updateDropdown(filterDaily, dailySet);
  updateDropdown(filterNhamay, nhamaySet);
  updateDropdown(filterTauColor, tauColorSet, true);
}
function updateRelatedDropdowns(records) {
  const cangxepSet = new Set(records.map(r => r.cangxep).filter(Boolean));
  const cangdenSet = new Set(records.map(r => r.cangden).filter(Boolean));
  const dailySet = new Set(records.map(r => r.daily).filter(Boolean));
  const nhamaySet = new Set(records.map(r => r.nhamay).filter(Boolean));
  const tauColorSet = new Set(records.map(r => r.tau_status_color).filter(Boolean));

  updateDropdown(filterCangxep, cangxepSet);
  updateDropdown(filterCangden, cangdenSet);
  updateDropdown(filterDaily, dailySet);
  updateDropdown(filterNhamay, nhamaySet);
  updateDropdown(filterTauColor, tauColorSet, true);
}
function updateTauDropdown(records) {
  const tauSet = new Set(records.map(r => r.tau).filter(Boolean));
  updateDropdown(filterTau, tauSet);
}
function updateDropdown(selectElem, valuesSet, isColor=false) {
  const selected = selectElem.value;
  const firstOption = selectElem.options[0];
  selectElem.innerHTML = "";
  selectElem.appendChild(firstOption);
  Array.from(valuesSet).sort().forEach(v => {
    const option = document.createElement("option");
    option.value = v;
    option.textContent = isColor ?
      (v=='bg-success' ? 'Ho√†n th√†nh' : v=='bg-warning' ? 'Ch∆∞a ho√†n th√†nh' : v)
      : v;
    if (v === selected) option.selected = true;
    selectElem.appendChild(option);
  });
}

// ========== Nh√≥m d·ªØ li·ªáu theo t√†u ==========
function prepareGroups() {
  groupedData = [];
  let group = [];
  let currentTau = null;

  allRows.forEach(r => {
    if (r.print_tau) {
      if (group.length) groupedData.push(group);
      group = [];
      currentTau = r.tau;
    }
    group.push(r);
  });
  if (group.length) groupedData.push(group);
}

// ========== Render 1 trang ==========
function renderPage(page) {
  currentPage = page;
  const start = (page - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const visibleGroups = groupedData.slice(start, end);
  const visibleRows = visibleGroups.flat();
  renderRows(visibleRows);
  renderPagination();
setTimeout(() => {
  const table = document.querySelector("#lichtau-table");
  if (table) {
    const container = table.closest(".table-responsive") || table.parentElement;
    if (container) container.scrollTop = 0;
  }
}, 100);
}

// ========== Render b·∫£ng ==========
function renderRows(rows) {
  tbody.innerHTML = "";
  rows.forEach(r => {
    const tr = document.createElement("tr");

    if (r.print_tau) {
      // C·ªôt T√†u, ƒê·∫°i l√Ω, C·∫£ng x·∫øp, C·∫£ng ƒë·∫øn
      const stickyCols = ["tau", "daily", "cangxep", "cangden"];
      stickyCols.forEach((k, index) => {
        const td = document.createElement("td");
        td.rowSpan = r.tau_rowspan || 1;
        td.classList.add("sticky-col", `sticky-col${index + 1}`);
        
        const wrapper = document.createElement("div");
        wrapper.className = `sticky-content sticky-col${index + 1}`;
        wrapper.textContent = r[k] || "";
        
        td.appendChild(wrapper);
        
        // T√¥ m√†u cho c·∫£ c·ªôt T√†u (c·∫£ td v√† wrapper)
        if (k === "tau" && r.tau_status_color) {
          td.classList.add(r.tau_status_color);
        }
        tr.appendChild(td);
      });
    }

    if (r.print_so) {
      // C·ªôt Sales Order
      const td_so = document.createElement("td");
      td_so.rowSpan = r.so_rowspan || 1;
      td_so.textContent = r.so || "";
      tr.appendChild(td_so);

      // C√°c c·ªôt kh√¥ng sticky c√≤n l·∫°i
      const td_nm = document.createElement("td");
      td_nm.rowSpan = r.so_rowspan || 1;
      td_nm.textContent = r.nhamay || "";
      tr.appendChild(td_nm);

      const td_dinh = document.createElement("td");
      td_dinh.rowSpan = r.so_rowspan || 1;
      td_dinh.textContent = r.dinh_luong || "";
      tr.appendChild(td_dinh);
    }

    ["material","mapping_kho","shipped_qty","qty","D·ª±_ƒêo√°n_Ho√†n_Th√†nh"].forEach(k => {
  const td = document.createElement("td");
  if (k === "D·ª±_ƒêo√°n_Ho√†n_Th√†nh") {
  const value = r[k] || "";
  td.textContent = value;
  td.className = "text-left italic";

  const hasDate = /\d{4}-\d{2}-\d{2}/.test(value); // c√≥ ng√†y kh√¥ng
  const hasFraction = /\d+\/\d+/.test(value);      // c√≥ d·∫°ng 24/44 kh√¥ng

  if (value.includes("ƒêang c√≥") && !hasFraction && !hasDate) {
    // C√≥ h√†ng ƒë·ªß (v√≠ d·ª•: "ƒêang c√≥ 30T ch∆∞a map")
    td.style.color = "#28a745"; // xanh l√°
  } 
  else if (hasFraction || (value.includes("ƒêang c√≥") && hasFraction) || (hasFraction && hasDate)) {
    // C√≥ d·∫°ng t·ª∑ l·ªá ho·∫∑c c√≥ c·∫£ t·ª∑ l·ªá + ng√†y ("24/44 - 2025-10-26")
    td.style.color = "#fd7e14"; // cam
  } 
  else if (hasDate && !hasFraction) {
    // Ch·ªâ c√≥ ng√†y (v√≠ d·ª• "2025-10-26")
    td.style.color = "#28a745"; // xanh l√°
  } 
  else {
    // Thi·∫øu to√†n b·ªô, r·ªóng, ho·∫∑c kh√¥ng nh·∫≠n d·∫°ng ƒë∆∞·ª£c
    td.style.color = "#dc3545"; // ƒë·ªè
  }
} else {
    td.textContent = r[k]?.toLocaleString?.("vi-VN") || "";
    if (["mapping_kho","shipped_qty","qty"].includes(k)) td.className = "text-right";
  }
  tr.appendChild(td);
});

    const tdProcess = document.createElement("td");
    const progress = document.createElement("div");
    progress.className = "progress position-relative";
    const bar = document.createElement("div");
    bar.className = "progress-bar " + (r.process_color || "");
    bar.style.width = (r.process_value || 0) + "%";
    const spanText = document.createElement("span");
    spanText.textContent = (r.process_value || 0).toFixed(1) + "%";
    spanText.style.position = "absolute";
    spanText.style.width = "100%";
    spanText.style.textAlign = "center";
    spanText.style.lineHeight = "22px";
    spanText.style.fontWeight = "bold";
    spanText.style.color = "#000";
    progress.appendChild(bar);
    progress.appendChild(spanText);
    tdProcess.appendChild(progress);
    tr.appendChild(tdProcess);

    tbody.appendChild(tr);
  });
}

// ========== Render pagination ==========
function renderPagination() {
  paginationDiv.innerHTML = "";
  const totalPages = Math.ceil(groupedData.length / rowsPerPage);
  if (totalPages <= 1) return;

  const btnPrev = document.createElement("button");
  btnPrev.textContent = "¬´";
  btnPrev.className = "btn btn-outline-primary btn-sm";
  btnPrev.disabled = currentPage === 1;
  btnPrev.onclick = () => renderPage(currentPage - 1);
  paginationDiv.appendChild(btnPrev);

  const span = document.createElement("span");
  span.textContent = `Trang ${currentPage}/${totalPages}`;
  paginationDiv.appendChild(span);

  const btnNext = document.createElement("button");
  btnNext.textContent = "¬ª";
  btnNext.className = "btn btn-outline-primary btn-sm";
  btnNext.disabled = currentPage === totalPages;
  btnNext.onclick = () => renderPage(currentPage + 1);
  paginationDiv.appendChild(btnNext);
}
function debounce(func, delay) {
  let timer;
  return function (...args) {
    clearTimeout(timer);
    timer = setTimeout(() => func.apply(this, args), delay);
  };
}
const fetchRowsDebounced = debounce(fetchRows, 300);
// ========== Event listeners ==========
[
  filterCangxep, filterCangden, filterDaily, filterNhamay, filterTauColor
].forEach(elem => elem.addEventListener("change", () => fetchRows("tau")));

filterTau.addEventListener("change", () => fetchRows("related")); // üëà khi ch·ªçn t√†u
filterSheetMonth.addEventListener("change", () => fetchRows(true));
keywordInput.addEventListener("input", () => fetchRowsDebounced(true));
btnReset.addEventListener("click", () => {
  keywordInput.value = "";
  filterTau.value = "";
  filterCangxep.value = "";
  filterCangden.value = "";
  filterDaily.value = "";
  filterNhamay.value = "";
  filterTauColor.value = "";
  fetchRows(true);
});
restoreFiltersFromURL();
// ========== Load l·∫ßn ƒë·∫ßu ==========
fetchRows(true);
</script>
{% endblock %}
